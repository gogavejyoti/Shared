<div id="shrinkageChart"></div>

<script>
function buildShrinkageComparisonChart(data, containerId) {
    // ---- aggregate shrinkage by weekFormat ----
    const weekMap = {};
    data.forEach(d => {
        if (!weekMap[d.weekFormat]) {
            weekMap[d.weekFormat] = {
                totalAvail: 0,
                plannedWeighted: 0,
                actualWeighted: 0
            };
        }
        const avail = d.availableHC || 0;
        weekMap[d.weekFormat].totalAvail += avail;
        weekMap[d.weekFormat].plannedWeighted += avail * (d.plannedShrinkage || 0);
        weekMap[d.weekFormat].actualWeighted += avail * (d.actualShrinkage || 0);
    });

    // ---- calculate aggregated shrinkages ----
    const weeks = Object.keys(weekMap).sort((a, b) => {
        // sort dd-MMM-yy format properly
        return new Date(a) - new Date(b);
    });

    const planned = weeks.map(w => {
        const total = weekMap[w].totalAvail;
        return total > 0 ? Math.round((weekMap[w].plannedWeighted / total) * 100) : null;
    });
    const actual = weeks.map(w => {
        const total = weekMap[w].totalAvail;
        return total > 0 ? Math.round((weekMap[w].actualWeighted / total) * 100) : null;
    });

    // ---- chart options ----
    const options = {
        chart: {
            type: 'bar',
            height: 300,
            stacked: false,
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '40%',
                endingShape: 'rounded'
            }
        },
        dataLabels: { enabled: false },
        colors: [app.color.theme, app.color.warning],
        series: [
            { name: "Planned Shrinkage", data: planned },
            { name: "Actual Shrinkage", data: actual }
        ],
        xaxis: {
            categories: weeks,
            labels: {
                rotate: -45
            },
            axisBorder: { show: true, color: app.color.borderColor },
            axisTicks: { show: true, color: app.color.borderColor }
        },
        yaxis: {
            title: { text: "Shrinkage %", style: { color: app.color.bodyColor } },
            labels: {
                formatter: val => val + "%",
                style: { colors: [app.color.bodyColor] }
            },
            min: 0
        },
        tooltip: {
            shared: true,
            y: {
                formatter: function (val) {
                    return val !== null ? val + "%" : "N/A";
                }
            }
        },
        legend: {
            position: "bottom",
            horizontalAlign: "center"
        }
    };

    // ---- destroy old chart & create new ----
    if (window.shrinkageChart) {
        window.shrinkageChart.destroy();
    }
    window.shrinkageChart = new ApexCharts(document.querySelector("#" + containerId), options);
    window.shrinkageChart.render();
}
</script>
