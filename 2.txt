(function ($) {
    $.fn.sheetConfigurator = function (options) {
        const settings = $.extend({
            luckysheetInstances: [],
            existingConfigs: {},
            activeSheet: null,
            saveCallback: function (config, sheetName) { },
            getSheetDataFn: function (sheetName) { return []; }
        }, options);

        let tempConfigs = {};

        // Inject Tailwind UI Modal once
        if (!$('#sheetConfigModal').length) {
            $('body').append(`
              <div id="sheetConfigModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl max-h-[90vh] overflow-auto">
                  <div class="flex justify-between items-center p-4 bg-blue-600 text-white rounded-t-lg">
                    <h3 class="text-lg font-semibold">Sheet Configuration</h3>
                    <button type="button" id="closeConfigModal" class="text-white text-xl">&times;</button>
                  </div>
                  <div class="p-4 space-y-4">
                    <form id="sheetConfigForm" class="space-y-4">
                      <div class="grid grid-cols-2 gap-4">
                        <div>
                          <label class="block font-medium text-gray-700">Sheet</label>
                          <select id="configSheetSelect" class="w-full border rounded px-2 py-1"></select>
                        </div>
                        <div>
                          <label class="block font-medium text-gray-700">Sheet Type</label>
                          <select id="configSheetType" class="w-full border rounded px-2 py-1">
                            <option value="">--Select--</option>
                            <option value="custom">Custom</option>
                            <option value="lob">LOB</option>
                          </select>
                        </div>
                      </div>

                      <div id="lobInputs" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <label class="block font-medium text-gray-700">LOB Type</label>
                            <select id="configLobType" class="w-full border rounded px-2 py-1">
                              <option value="FTE">FTE</option>
                              <option value="Transaction">Transaction</option>
                            </select>
                          </div>
                          <div>
                            <label class="block font-medium text-gray-700">Location</label>
                            <select id="configLocation" class="w-full border rounded px-2 py-1">
                              <option value="Bulgaria">Bulgaria</option>
                              <option value="Canada">Canada</option>
                              <option value="China">China</option>
                              <option value="Colombia">Colombia</option>
                              <option value="Egypt">Egypt</option>
                              <option value="India">India</option>
                              <option value="Jamaica">Jamaica</option>
                              <option value="Kosovo">Kosovo</option>
                              <option value="Malaysia">Malaysia</option>
                              <option value="Mexico">Mexico</option>
                              <option value="Philippines">Philippines</option>
                              <option value="USA">USA</option>
                            </select>
                          </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <label class="block font-medium text-gray-700">Site</label>
                            <input type="text" id="configSite" class="w-full border rounded px-2 py-1">
                          </div>
                          <div>
                            <label class="block font-medium text-gray-700">ProjectId</label>
                            <input type="text" id="configProjectId" class="w-full border rounded px-2 py-1">
                          </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                          <div>
                            <label class="block font-medium text-gray-700">Week Header Row</label>
                            <input type="number" min="1" id="configWeekRow" class="w-full border rounded px-2 py-1">
                            <small id="weekDateLabel" class="text-gray-600"></small>
                          </div>
                          <div>
                            <label class="block font-medium text-gray-700">Header Column</label>
                            <input type="text" id="configHeaderCol" class="w-full border rounded px-2 py-1">
                          </div>
                        </div>
                      </div>

                      <div id="headerMappingContainer" class="space-y-2"></div>
                    </form>
                    <div class="flex justify-end space-x-2 pt-4 border-t">
                      <button id="closeConfigModalBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Close</button>
                      <button id="saveConfigBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
                    </div>
                  </div>
                </div>
              </div>
            `);
        }

        const $sheetSelect = $('#configSheetSelect');
        const $sheetType = $('#configSheetType');
        const $lobInputs = $('#lobInputs');
        const $site = $('#configSite');
        const $projectId = $('#configProjectId');
        const $weekRow = $('#configWeekRow');
        const $headerCol = $('#configHeaderCol');
        const $mappingContainer = $('#headerMappingContainer');
        const $weekLabel = $('#weekDateLabel');

        $('#closeConfigModal, #closeConfigModalBtn').on('click', () => $('#sheetConfigModal').addClass('hidden'));

        function getFormConfig(sheetName) {
            const cfg = {
                sheetName,
                type: $sheetType.val(),
                lobType: $('#configLobType').val(),
                location: $('#configLocation').val(),
                site: $site.val(),
                projectId: $projectId.val(),
                weekRow: $weekRow.val(),
                headerCol: $headerCol.val(),
                headerMappings: {}
            };
            $('.mapping-dropdown').each(function () {
                const std = $(this).data('std');
                const val = $(this).val();
                if (val) cfg.headerMappings[std] = val;
            });
            return cfg;
        }

        function bindConfig(config) {
            $sheetType.val('').trigger('change');
            $lobInputs.addClass('hidden');
            $site.val('');
            $projectId.val('');
            $weekRow.val('');
            $headerCol.val('');
            $mappingContainer.empty();
            $weekLabel.text('');

            if (!config) return;

            $sheetType.val(config.type).trigger('change');
            if (config.type === 'lob') $lobInputs.removeClass('hidden');
            $('#configLobType').val(config.lobType);
            $('#configLocation').val(config.location);
            $site.val(config.site);
            $projectId.val(config.projectId);
            $weekRow.val(config.weekRow);
            $headerCol.val(config.headerCol);

            if (config.headerCol) {
                const sheetData = settings.getSheetDataFn(config.sheetName);
                buildHeaderMapping(sheetData, config.headerCol, config.headerMappings);
            }
        }

        function validateWeekRow(sheet, rowNum) {
            const row = sheet.data ? sheet.data[rowNum - 1] : sheet[rowNum - 1];
            if (!row) return { valid: false };
            let start = null, end = null;
            row.forEach(cell => {
                const val = cell && (cell.m || cell.v);
                if (val && !isNaN(Date.parse(val))) {
                    if (start === null) start = val;
                    end = val;
                }
            });
            return { valid: start !== null, start, end };
        }

        function buildHeaderMapping(sheetData, colInput, existingMappings) {
            if (!colInput) return;
            let colIdx = isNaN(colInput)
                ? colInput.toUpperCase().charCodeAt(0) - 65
                : parseInt(colInput) - 1;

            const headers = [];
            for (let r = 0; r < sheetData.length; r++) {
                const cell = sheetData[r][colIdx];
                if (cell) {
                    const val = cell.m || cell.v || "";
                    if (val) headers.push(val);
                }
            }
            headers.push("Not Applicable");
            const uniqueHeaders = [...new Set(headers.filter(h => h.trim() !== ""))];

            $mappingContainer.empty();
            if (!uniqueHeaders.length) return;

            const standardHeaders = ["Client Lock", "Forecasted Hours", "Actual Hours", "Required HC", "Available HC", "Planned Attrition", "Actual Attrition", "Planned Shrinkage", "Actual Shrinkage", "Planned AHT", "Actual AHT"];
            standardHeaders.forEach(std => {
                let options = uniqueHeaders.map(h =>
                    `<option value="${h}" ${existingMappings && existingMappings[std] === h ? "selected" : ""}>${h}</option>`
                ).join("");
                $mappingContainer.append(`
                  <div class="grid grid-cols-2 gap-4 items-center">
                    <label class="font-medium text-gray-700">${std}</label>
                    <select class="mapping-dropdown border rounded px-2 py-1" data-std="${std}">
                      <option value="">--Select--</option>
                      ${options}
                    </select>
                  </div>
                `);
            });
        }

        $sheetSelect.empty();
        settings.luckysheetInstances.forEach(name => {
            $sheetSelect.append(`<option value="${name}">${name}</option>`);
        });

        if (settings.activeSheet) {
            $sheetSelect.val(settings.activeSheet);
            bindConfig(settings.existingConfigs[settings.activeSheet] || null);
            $sheetSelect.data('lastSheet', settings.activeSheet);
        }

        $sheetSelect.off('change').on('change', function () {
            const prevSheet = $(this).data('lastSheet');
            const newSheet = $(this).val();
            if (prevSheet) {
                tempConfigs[prevSheet] = getFormConfig(prevSheet);
            }
            const config = tempConfigs[newSheet] || settings.existingConfigs[newSheet] || null;
            bindConfig(config);
            $(this).data('lastSheet', newSheet);
        });

        $weekRow.off('blur').on('blur', function () {
            const sheetName = $sheetSelect.val();
            const sheetData = settings.getSheetDataFn(sheetName) || [];
            const weekCheck = validateWeekRow({ data: sheetData }, parseInt($(this).val()));
            if (weekCheck.valid) {
                $weekLabel.text(`Start: ${weekCheck.start} → End: ${weekCheck.end}`);
            } else {
                $weekLabel.text("Invalid week row (no dates found).");
            }
        });

        $headerCol.off('blur').on('blur', function () {
            const sheetName = $sheetSelect.val();
            const sheetData = settings.getSheetDataFn(sheetName) || [];
            buildHeaderMapping(sheetData, $(this).val(), {});
        });

        $('#saveConfigBtn').off('click').on('click', function () {
            const sheetName = $sheetSelect.val();
            const config = getFormConfig(sheetName);
            settings.existingConfigs[sheetName] = config;
            delete tempConfigs[sheetName];
            settings.saveCallback(config, sheetName);
            $('#sheetConfigModal').addClass('hidden');
        });

        return this;
    };
})(jQuery);
