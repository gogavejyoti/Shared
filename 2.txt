function _shiftSameSheetReference({
    type,
    sheetIndex,
    rowIndex,
    rowCount = 1,
    colIndex,
    colCount = 1
}) {
    const allSheets = Ft() || [];
    const sheet = allSheets[sheetIndex];
    if (!sheet || !sheet.data) return;

    let sheetChanged = false;

    // Match single or range references WITHOUT sheet name
    // Examples: A1, $A$1, A1:B10, $A1:B$10
    const referenceRegex = /\$?([A-Z]+)\$?(\d+)(:\$?([A-Z]+)\$?(\d+))?/g;

    const data = sheet.data;

    for (let r = 0; r < data.length; r++) {
        if (!data[r]) continue;

        for (let c = 0; c < data[r].length; c++) {
            const cell = data[r][c];
            if (!cell || !cell.f) continue;

            let originalFormula = cell.f;
            let modifiedFormula = originalFormula;
            let errorDetected = false;

            modifiedFormula = modifiedFormula.replace(referenceRegex, function (
                match,
                startCol, startRow,
                _range,
                endCol, endRow
            ) {
                // --- Detect $ flags ---
                const startAbsCol = match.startsWith("$") ? "$" : "";
                const startAbsRow = /\$\d+/.test(match) ? "$" : "";

                let endAbsCol = "";
                let endAbsRow = "";
                if (endCol || endRow) {
                    const rangePart = match.split(":")[1];
                    if (rangePart) {
                        endAbsCol = rangePart.startsWith("$") ? "$" : "";
                        endAbsRow = /\$\d+/.test(rangePart) ? "$" : "";
                    }
                }

                // --- Convert to indices ---
                let startColIndex = _columnLetterToIndex(startCol);
                let startRowIndex = parseInt(startRow, 10);
                let endColIndex = endCol ? _columnLetterToIndex(endCol) : startColIndex;
                let endRowIndex = endRow ? parseInt(endRow, 10) : startRowIndex;

                let rowDeleted = false;
                let colDeleted = false;

                // --- Row shifts ---
                if (type === "insertRow") {
                    if (!startAbsRow && startRowIndex >= rowIndex + 1)
                        startRowIndex += rowCount;
                    if (!endAbsRow && endRowIndex >= rowIndex + 1)
                        endRowIndex += rowCount;
                }

                if (type === "deleteRow") {
                    if (
                        (startRowIndex > rowIndex && startRowIndex <= rowIndex + rowCount) ||
                        (endRowIndex > rowIndex && endRowIndex <= rowIndex + rowCount)
                    ) {
                        rowDeleted = true;
                        errorDetected = true;
                    } else {
                        if (!startAbsRow && startRowIndex > rowIndex + rowCount)
                            startRowIndex -= rowCount;
                        if (!endAbsRow && endRowIndex > rowIndex + rowCount)
                            endRowIndex -= rowCount;
                    }
                }

                // --- Column shifts ---
                if (type === "insertCol") {
                    if (!startAbsCol && startColIndex >= colIndex)
                        startColIndex += colCount;
                    if (!endAbsCol && endColIndex >= colIndex)
                        endColIndex += colCount;
                }

                if (type === "deleteCol") {
                    if (
                        (startColIndex >= colIndex && startColIndex < colIndex + colCount) ||
                        (endColIndex >= colIndex && endColIndex < colIndex + colCount)
                    ) {
                        colDeleted = true;
                        errorDetected = true;
                    } else {
                        if (!startAbsCol && startColIndex >= colIndex + colCount)
                            startColIndex -= colCount;
                        if (!endAbsCol && endColIndex >= colIndex + colCount)
                            endColIndex -= colCount;
                    }
                }

                if (rowDeleted || colDeleted) return "#REF!";

                // --- Rebuild reference ---
                const startRef =
                    `${startAbsCol}${_columnIndexToLetter(startColIndex)}` +
                    `${startAbsRow}${startRowIndex}`;

                if (!endCol && !endRow) {
                    return startRef;
                }

                const endRef =
                    `${endAbsCol}${_columnIndexToLetter(endColIndex)}` +
                    `${endAbsRow}${endRowIndex}`;

                return `${startRef}:${endRef}`;
            });

            if (modifiedFormula !== originalFormula) {
                cell.f = modifiedFormula;
                sheetChanged = true;

                if (errorDetected) {
                    cell.v = "#REF!";
                    cell.ct = { fa: "General", t: "e" };
                }
            }
        }
    }

    if (sheetChanged) {
        if (typeof jf !== "undefined" && jf.refresh)
            jf.refresh();
        else if (typeof luckysheetrefreshgrid === "function")
            luckysheetrefreshgrid();
    }

    // --- Helpers ---
    function _columnLetterToIndex(col) {
        let index = 0;
        for (let i = 0; i < col.length; i++) {
            index = index * 26 + (col.charCodeAt(i) - 65 + 1);
        }
        return index - 1;
    }

    function _columnIndexToLetter(index) {
        let col = "";
        index += 1;
        while (index > 0) {
            let rem = (index - 1) % 26;
            col = String.fromCharCode(65 + rem) + col;
            index = Math.floor((index - 1) / 26);
        }
        return col;
    }
}
