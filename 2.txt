(function ($) {
    $.fn.staffingSummaryContainer = function (options) {
        const settings = $.extend({
            data: [],
            containerId: null // optional now
        }, options);

        $('#analyticsModal').remove();

        const uniqueLobs = [...new Set(settings.data.map(d => d.lob))];
        const uniqueWeeks = [...new Set(settings.data.map(d => d.week))];
        const uniqueGeos = [...new Set(settings.data.map(d => d.geo))];
        const uniqueSites = [...new Set(settings.data.map(d => d.site))];
        const uniqueProjects = [...new Set(settings.data.map(d => d.projectid))];

        const metrics = ["Required HC", "Available HC", "Delta", "Staffing %"];

        // inject CSS (fixed only)
        if (!document.getElementById("staffing-summary-styles")) {
            $("<style id='staffing-summary-styles'>").text(`
                #analyticsModal .modal-content { border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-family: 'Inter', sans-serif; background: #fafafa; }
                #analyticsModal .modal-header { border-bottom: 1px solid #e0e0e0; background-color: #D7C4F0; color: #2c2c2c; }
                #analyticsModal .modal-title { font-weight: 600; color: #2c2c2c; }
                #analyticsModal .btn-close { filter: invert(30%); }

                /* wrapper scroll fix */
                #analyticsModal .staffing-summary-table-wrapper {
                    overflow-x: auto;
                    overflow-y: auto;
                    max-height: 70vh; /* height as per screen */
                    position: relative;
                    border: 1px solid #dcdcdc;
                    background: #fff;
                    border-radius: 8px;
                    margin: 10px;
                }

                #analyticsModal .staffing-summary-table {
                    width: 100%;
                    border-collapse: collapse;
                    table-layout: auto; /* prevent squeezing */
                    min-width: 100%;
                }

                /* Sticky header */
                #analyticsModal .staffing-summary-table thead th {
                    position: sticky;
                    top: 0;
                    background: #1E93AB;
                    color: #fff;
                    z-index: 20;
                    white-space: nowrap;
                    padding: 6px;
                }

                /* Sticky first column */
                #analyticsModal .staffing-summary-table th.sticky-col,
                #analyticsModal .staffing-summary-table td.sticky-col {
                    position: sticky;
                    left: 0;
                    background: #fff;
                    z-index: 15;
                    min-width: 200px;
                }

                /* Sticky corner cell */
                #analyticsModal .staffing-summary-table thead th.sticky-col {
                    z-index: 25;
                    background: #1E93AB;
                    color: #fff;
                }

                #analyticsModal .staffing-summary-table th,
                #analyticsModal .staffing-summary-table td {
                    border: 1px solid #ddd;
                    text-align: center;
                    font-size: 12px;
                    color: #000;
                }

                #analyticsModal .staffing-summary-table tr.summary-row td { font-weight: bold; background: #F5FAE1; }
                #analyticsModal .staffing-summary-table tr.lob-row td {
                    background: #FFF; font-weight: bold; padding: 8px;
                    text-align: center; white-space: nowrap; overflow: hidden;
                    text-overflow: ellipsis; border: 1px solid #eaeaea;
                }

                .rag-red { color: #e74c3c !important; }
                .rag-amber { color: #f39c12 !important; }
                .rag-green { color: #27ae60 !important; }

                #analyticsModal .staffing-summary-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; margin-left: 10px; justify-content: space-between; }
                #analyticsModal .filter-group { position: relative;color:#000 }
                #analyticsModal .filter-dropdown { display: none; position: absolute; background: #fff; border: 1px solid #ddd; padding: 5px; z-index: 100; max-height: 200px; overflow-y: auto; width:100% }
                #analyticsModal .filter-group.open .filter-dropdown { display: block; }
            `).appendTo("head");
        }

        $('#analyticsModal').on('hidden.bs.modal', function () {
            $('#analyticsModal').remove();
            $('#staffing-summary-styles').remove();
        });

        // reusable filter rendering
        function renderMultiSelect(label, options, key) {
            const html = `
                <div class="filter-group" data-key="${key}">
                    <button type="button" class="form-control form-select" style="min-width:150px;font-size: 12px;background: #fafafa;color: #000;border: 1px solid;border-radius: 5px;">${label}: Select All</button>
                    <div class="filter-dropdown">
                        <label><input type="checkbox" value="all" checked> Select All</label><br/>
                        ${options.map(opt => `<label><input type="checkbox" value="${opt}" checked> ${opt}</label><br/>`).join("")}
                    </div>
                </div>
            `;
            return html;
        }

        function renderRadioSelect(label, options, key, defaultVal) {
            const html = `
                <div class="filter-group" data-key="${key}">
                    <button type="button" class="form-control form-select" style="min-width:150px;font-size: 12px;background: #fafafa;color: #000;border: 1px solid;border-radius: 5px;">${label}: ${defaultVal}</button>
                    <div class="filter-dropdown">
                        ${options.map(opt => `<label><input type="radio" name="${key}" value="${opt}" ${opt === defaultVal ? "checked" : ""}> ${opt}</label><br/>`).join("")}
                    </div>
                </div>
            `;
            return html;
        }

        // build UI
        $('body').append(`
 <div class="modal fade" id="analyticsModal" tabindex="-1" style="z-index:9999;zoom:85%">
          <div class="modal-dialog" style="width: 100%;margin: 0;height: 100%;max-width: none;">
