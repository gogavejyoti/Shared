(function ($) {
    $.fn.staffingSummaryPopup = function (options) {
        const settings = $.extend({
            containerId: null,
            data: []
        }, options);

        if (!settings.containerId) {
            console.error("âŒ containerId is required!");
            return;
        }

        const container = $("#" + settings.containerId);
        container.empty();

        // ðŸ”¹ Get distinct values
        function getUniqueValues(field) {
            return [...new Set(settings.data.map(d => d[field]).filter(v => v != null))];
        }

        // ðŸ”¹ Build filter + table HTML
        const html = `
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <h5 class="mb-3"><i class="fas fa-filter text-primary"></i> Filters</h5>
                    <div class="row g-2">
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Geo</label>
                            <select id="filterGeo" class="form-select" multiple></select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Site</label>
                            <select id="filterSite" class="form-select" multiple></select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Project Id</label>
                            <select id="filterProjectId" class="form-select" multiple></select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">LOB</label>
                            <select id="filterLOB" class="form-select" multiple></select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Metrics</label>
                            <select id="filterMetrics" class="form-select" multiple></select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Week From</label>
                            <select id="filterWeekFrom" class="form-select"></select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Week To</label>
                            <select id="filterWeekTo" class="form-select"></select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Summary Type</label>
                            <select id="filterSummaryType" class="form-select">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button id="applyFilters" class="btn btn-primary w-100">
                                <i class="fas fa-sync-alt"></i> Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table id="summaryTable" class="table table-bordered table-striped align-middle">
                    <thead class="table-dark">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        `;
        container.append(html);

        // ðŸ”¹ Populate dropdowns
        function populateDropdown(id, values) {
            const select = $(id);
            select.empty();
            values.forEach(v => select.append(`<option value="${v}">${v}</option>`));
        }

        populateDropdown("#filterGeo", getUniqueValues("Geo"));
        populateDropdown("#filterSite", getUniqueValues("Site"));
        populateDropdown("#filterProjectId", getUniqueValues("ProjectId"));
        populateDropdown("#filterLOB", getUniqueValues("LOB"));
        populateDropdown("#filterMetrics", getUniqueValues("Header"));
        populateDropdown("#filterWeekFrom", getUniqueValues("Week"));
        populateDropdown("#filterWeekTo", getUniqueValues("Week"));

        // ðŸ”¹ Build table
        function buildTable() {
            const selectedGeo = $("#filterGeo").val() || [];
            const selectedSite = $("#filterSite").val() || [];
            const selectedProjectId = $("#filterProjectId").val() || [];
            const selectedLOBs = $("#filterLOB").val() || [];
            const selectedMetrics = $("#filterMetrics").val() || [];
            const weekFrom = $("#filterWeekFrom").val();
            const weekTo = $("#filterWeekTo").val();

            let filtered = settings.data;

            if (selectedGeo.length) filtered = filtered.filter(d => selectedGeo.includes(d.Geo));
            if (selectedSite.length) filtered = filtered.filter(d => selectedSite.includes(d.Site));
            if (selectedProjectId.length) filtered = filtered.filter(d => selectedProjectId.includes(d.ProjectId));
            if (selectedLOBs.length) filtered = filtered.filter(d => selectedLOBs.includes(d.LOB));
            if (selectedMetrics.length) filtered = filtered.filter(d => selectedMetrics.includes(d.Header));

            if (weekFrom && weekTo) {
                const weeks = getUniqueValues("Week");
                const fromIndex = weeks.indexOf(weekFrom);
                const toIndex = weeks.indexOf(weekTo);
                const range = weeks.slice(Math.min(fromIndex, toIndex), Math.max(fromIndex, toIndex) + 1);
                filtered = filtered.filter(d => range.includes(d.Week));
            }

            // ðŸ”¹ Build header
            const headers = ["Geo", "Site", "ProjectId", "LOB", "Week", "Month", "Header", "Value"];
            $("#tableHeader").empty();
            headers.forEach(h => $("#tableHeader").append(`<th>${h}</th>`));

            // ðŸ”¹ Build body
            $("#tableBody").empty();
            filtered.forEach(row => {
                $("#tableBody").append(`
                    <tr>
                        <td>${row.Geo}</td>
                        <td>${row.Site}</td>
                        <td>${row.ProjectId}</td>
                        <td>${row.LOB}</td>
                        <td>${row.Week}</td>
                        <td>${row.Month}</td>
                        <td>${row.Header}</td>
                        <td>${row.Value}</td>
                    </tr>
                `);
            });
        }

        // ðŸ”¹ Apply filters
        $("#applyFilters").on("click", function () {
            buildTable();
        });

        // ðŸ”¹ Initial table
        buildTable();
    };
}(jQuery));
