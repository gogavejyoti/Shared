Implicit conversion from data type nvarchar(max) to varbinary(max) is not allowed. Use the CONVERT function to run this query.

ALTER TABLE RP_PlanSheets_Travel
ADD JsonDataCompressed VARBINARY(MAX) NULL;

UPDATE RP_PlanSheets_Travel
SET JsonDataCompressed = COMPRESS(CONVERT(VARBINARY(MAX), JsonData));


ALTER TABLE RP_PlanSheets_Travel
DROP COLUMN JsonData;

EXEC sp_rename 
    'RP_PlanSheets_Travel.JsonDataCompressed',
    'JsonData',
    'COLUMN';

-- Change column to VARBINARY
ALTER TABLE RP_PlanSheets_Travel
ALTER COLUMN JsonData VARBINARY(MAX);

-- Store compressed JSON
INSERT INTO RP_PlanSheets_Travel (RPPlanId, JsonData)
VALUES (1, COMPRESS(CAST(@JsonText AS NVARCHAR(MAX))));

-- Read
SELECT CAST(DECOMPRESS(JsonData) AS NVARCHAR(MAX)) AS JsonText
FROM RP_PlanSheets_Travel
WHERE RPPlanId = @PlanId;


