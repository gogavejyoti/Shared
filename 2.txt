using Microsoft.AspNetCore.Mvc;
using System.Text;
using System.Text.Json;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;

namespace YourNamespace.Controllers
{
    // --------------------------- DTO Models ---------------------------

    public class WeekSet
    {
        public List<string> Actual { get; set; }
        public List<string> Forecast { get; set; }
        public string NextWeek { get; set; }
    }

    public class MetricValue
    {
        public string Week { get; set; }
        public double Value { get; set; }
    }

    public class DataPoint
    {
        public string Geo { get; set; }
        public string Site { get; set; }
        public string SheetName { get; set; }  // LOB Name
        public string ProjectId { get; set; }
        public string PlanId { get; set; }
        public string Header { get; set; }
        public List<MetricValue> Values { get; set; }
    }

    public class PlannerRequest
    {
        public WeekSet Weeks { get; set; }
        public List<DataPoint> Data { get; set; }
    }

    public class AIInsight
    {
        public string Lob { get; set; }
        public string Metric { get; set; }
        public string AlertType { get; set; }
        public string Summary { get; set; }
        public string Recommendation { get; set; }
    }

    // --------------------------- AI Formatter ---------------------------

    public static class AIDataFormatter
    {
        public static string Transform(PlannerRequest request)
        {
            var sb = new StringBuilder();
            sb.AppendLine("Analyze workforce performance and provide alerts and recommendations.");
            sb.AppendLine("Compare Planned vs Actual metrics (Attrition %, Shrinkage %, HC).");
            sb.AppendLine("Also analyze Staffing Delta = Available HC - Required HC, and Staffing% = (Available HC / Required HC)*100.\n");

            // Group data by LOB + Geo + Site
            var grouped = request.Data.GroupBy(d => new { d.SheetName, d.Geo, d.Site });

            foreach (var group in grouped)
            {
                sb.AppendLine($"LOB: {group.Key.SheetName} | Geo: {group.Key.Geo} | Site: {group.Key.Site}");

                // ------------------ Planned vs Actual Comparison ------------------
                var plannedMetrics = group.Where(g => g.Header.StartsWith("Planned", System.StringComparison.OrdinalIgnoreCase)).ToList();
                var actualMetrics = group.Where(g => g.Header.StartsWith("Actual", System.StringComparison.OrdinalIgnoreCase)).ToList();

                foreach (var planned in plannedMetrics)
                {
                    var metricBase = planned.Header.Replace("Planned", "").Trim();
                    var actual = actualMetrics.FirstOrDefault(a => a.Header.Contains(metricBase, System.StringComparison.OrdinalIgnoreCase));

                    if (actual == null)
                    {
                        sb.AppendLine($"- Metric: {planned.Header} (no Actual data to compare)");
                        continue;
                    }

                    sb.AppendLine($"- Metric: {metricBase}");
                    sb.AppendLine($"  Planned Trend: {string.Join(", ", planned.Values.Select(v => $"{v.Week}: {v.Value}"))}");
                    sb.AppendLine($"  Actual Trend:  {string.Join(", ", actual.Values.Select(v => $"{v.Week}: {v.Value}"))}");

                    var avgPlanned = planned.Values.Average(v => v.Value);
                    var avgActual = actual.Values.Average(v => v.Value);
                    var delta = avgActual - avgPlanned;

                    sb.AppendLine($"  Average Planned: {avgPlanned:F2}, Average Actual: {avgActual:F2}, Variance: {delta:+0.00;-0.00}%");
                    sb.AppendLine();
                }

                // ------------------ Staffing Delta & Staffing % ------------------
                var requiredHC = group.FirstOrDefault(x => x.Header.Equals("Required HC", System.StringComparison.OrdinalIgnoreCase));
                var availableHC = group.FirstOrDefault(x => x.Header.Equals("Available HC", System.StringComparison.OrdinalIgnoreCase));

                if (requiredHC != null && availableHC != null)
                {
                    sb.AppendLine("Derived Metrics:");
                    var derivedByWeek = new List<string>();

                    foreach (var week in requiredHC.Values.Select(v => v.Week))
                    {
                        var req = requiredHC.Values.FirstOrDefault(v => v.Week == week)?.Value ?? 0;
                        var avail = availableHC.Values.FirstOrDefault(v => v.Week == week)?.Value ?? 0;

                        var delta = avail - req;
                        var staffingPct = req != 0 ? (avail / req) * 100 : 0;

                        derivedByWeek.Add($"{week}: Delta={delta:F2}, Staffing%={staffingPct:F1}%");
                    }

                    sb.AppendLine("  " + string.Join(", ", derivedByWeek));

                    var avgDelta = availableHC.Values.Average(v => v.Value) - requiredHC.Values.Average(v => v.Value);
                    var avgStaffingPct = requiredHC.Values.Zip(availableHC.Values, (r, a) => r.Value != 0 ? (a.Value / r.Value) * 100 : 0).Average();

                    sb.AppendLine($"  Avg Delta: {avgDelta:F2}, Avg Staffing%: {avgStaffingPct:F1}%\n");
                    sb.AppendLine("Highlight staffing shortages or overcapacity and recommend resource actions.\n");
                }

                sb.AppendLine("Identify anomalies, declining performance, or forecast risks.\n");
            }

            return sb.ToString();
        }
    }

    // --------------------------- AI Service Interface ---------------------------

    public interface IAIAnalyzer
    {
        Task<List<AIInsight>> GenerateInsightsAsync(string aiInput);
    }

    public class OpenAIAIAnalyzer : IAIAnalyzer
    {
        private readonly HttpClient _httpClient;
        private readonly string _apiKey;

        public OpenAIAIAnalyzer(HttpClient httpClient, IConfiguration config)
        {
            _httpClient = httpClient;
            _apiKey = config["OpenAI:ApiKey"];
        }

        public async Task<List<AIInsight>> GenerateInsightsAsync(string aiInput)
        {
            var requestBody = new
            {
                model = "gpt-4-turbo",
                messages = new[]
                {
                    new { role = "system", content = "You are an expert in workforce and capacity planning analytics. Return structured JSON output with insights." },
                    new { role = "user", content = aiInput }
                },
                response_format = new { type = "json_object" }
            };

            var request = new HttpRequestMessage(HttpMethod.Post, "https://api.openai.com/v1/chat/completions");
            request.Headers.Add("Authorization", $"Bearer {_apiKey}");
            request.Content = JsonContent.Create(requestBody);

            var response = await _httpClient.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var content = await response.Content.ReadAsStringAsync();

            using var doc = JsonDocument.Parse(content);
            var resultText = doc.RootElement
                .GetProperty("choices")[0]
                .GetProperty("message")
                .GetProperty("content")
                .GetString();

            try
            {
                var parsed = JsonSerializer.Deserialize<List<AIInsight>>(resultText);
                return parsed ?? new List<AIInsight>();
            }
            catch
            {
                return new List<AIInsight> { new AIInsight { Summary = resultText } };
            }
        }
    }

    // --------------------------- Controller ---------------------------

    [ApiController]
    [Route("api/[controller]")]
    public class PlannerAIController : ControllerBase
    {
        private readonly IAIAnalyzer _aiAnalyzer;

        public PlannerAIController(IAIAnalyzer aiAnalyzer)
        {
            _aiAnalyzer = aiAnalyzer;
        }

        [HttpPost("analyze")]
        public async Task<IActionResult> AnalyzePlannerData([FromBody] PlannerRequest request)
        {
            if (request == null || request.Data == null || !request.Data.Any())
                return BadRequest("Invalid or empty data.");

            var aiInput = AIDataFormatter.Transform(request);
            var insights = await _aiAnalyzer.GenerateInsightsAsync(aiInput);

            return Ok(new { success = true, insights });
        }
    }
}



// Example function to send planner data to AI API
function sendPlannerDataToAI() {
    // --- SAMPLE DATA (replace this with your LuckySheet JSON) ---
    const plannerData = {
        weeks: {
            actual: ["24-Aug-25","31-Aug-25","07-Sep-25","14-Sep-25","21-Sep-25"],
            forecast: ["28-Sep-25","05-Oct-25","12-Oct-25","19-Oct-25","26-Oct-25"],
            nextWeek: "28-Sep-25"
        },
        data: [
            {
                geo: "India",
                site: "Hyderabad",
                sheetName: "IND EN R1 Lanco",
                projectId: "10789",
                planId: "79",
                header: "Required HC",
                values: [
                    { week: "24-Aug-25", value: 150 },
                    { week: "31-Aug-25", value: 152 },
                    { week: "07-Sep-25", value: 148 }
                ]
            },
            {
                geo: "India",
                site: "Hyderabad",
                sheetName: "IND EN R1 Lanco",
                projectId: "10789",
                planId: "79",
                header: "Available HC",
                values: [
                    { week: "24-Aug-25", value: 145 },
                    { week: "31-Aug-25", value: 147 },
                    { week: "07-Sep-25", value: 140 }
                ]
            },
            {
                geo: "India",
                site: "Hyderabad",
                sheetName: "IND EN R1 Lanco",
                projectId: "10789",
                planId: "79",
                header: "Planned Attrition",
                values: [
                    { week: "24-Aug-25", value: 2.5 },
                    { week: "31-Aug-25", value: 2.2 },
                    { week: "07-Sep-25", value: 2.1 }
                ]
            },
            {
                geo: "India",
                site: "Hyderabad",
                sheetName: "IND EN R1 Lanco",
                projectId: "10789",
                planId: "79",
                header: "Actual Attrition",
                values: [
                    { week: "24-Aug-25", value: 2.7 },
                    { week: "31-Aug-25", value: 2.4 },
                    { week: "07-Sep-25", value: 2.3 }
                ]
            }
        ]
    };

    // --- DERIVED METRICS CALCULATION (FTE Delta & Staffing %) ---
    const required = plannerData.data.find(d => d.header === "Required HC");
    const available = plannerData.data.find(d => d.header === "Available HC");

    if (required && available) {
        const deltaData = {
            geo: required.geo,
            site: required.site,
            sheetName: required.sheetName,
            projectId: required.projectId,
            planId: required.planId,
            header: "FTE Delta",
            values: []
        };

        const staffingData = {
            geo: required.geo,
            site: required.site,
            sheetName: required.sheetName,
            projectId: required.projectId,
            planId: required.planId,
            header: "Staffing %",
            values: []
        };

        required.values.forEach((reqVal, i) => {
            const availVal = available.values[i];
            if (availVal) {
                const delta = availVal.value - reqVal.value;
                const staffingPercent = reqVal.value ? ((availVal.value / reqVal.value) * 100).toFixed(2) : 0;
                deltaData.values.push({ week: reqVal.week, value: delta });
                staffingData.values.push({ week: reqVal.week, value: staffingPercent });
            }
        });

        plannerData.data.push(deltaData);
        plannerData.data.push(staffingData);
    }

    // --- API CALL ---
    $.ajax({
        url: "/api/PlannerAI/analyze",  // Your C# API endpoint
        method: "POST",
        data: JSON.stringify(plannerData),
        contentType: "application/json",
        beforeSend: function() {
            console.log("Sending planner data to AI engine...");
        },
        success: function(response) {
            console.log("AI Insights:", response);

            // Example: show alerts on screen
            if (response && response.insights) {
                let html = "<h4>AI Recommendations</h4><ul>";
                response.insights.forEach(insight => {
                    html += `<li><b>${insight.metric}</b>: ${insight.message} <br><em>${insight.recommendation}</em></li>`;
                });
                html += "</ul>";
                $("#aiResult").html(html);
            }
        },
        error: function(xhr) {
            console.error("AI API call failed:", xhr.responseText);
            alert("Error sending data to AI API.");
        }
    });
}


