using Microsoft.AspNetCore.Mvc;
using System.Text;
using System.Text.Json;
using System.Linq;
using System.Threading.Tasks;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;

namespace YourNamespace.Controllers
{
    // --------------------------- DTO Models ---------------------------

    public class WeekSet
    {
        public List<string> Actual { get; set; }
        public List<string> Forecast { get; set; }
        public string NextWeek { get; set; }
    }

    public class MetricValue
    {
        public string Week { get; set; }
        public double Value { get; set; }
    }

    public class DataPoint
    {
        public string Geo { get; set; }
        public string Site { get; set; }
        public string SheetName { get; set; }  // LOB Name
        public string ProjectId { get; set; }
        public string PlanId { get; set; }
        public string Header { get; set; }
        public List<MetricValue> Values { get; set; }
    }

    public class PlannerRequest
    {
        public WeekSet Weeks { get; set; }
        public List<DataPoint> Data { get; set; }
    }

    public class AIInsight
    {
        public string Lob { get; set; }
        public string Metric { get; set; }
        public string AlertType { get; set; }
        public string Summary { get; set; }
        public string Recommendation { get; set; }
    }

    // --------------------------- AI Formatter ---------------------------

    public static class AIDataFormatter
    {
        public static string Transform(PlannerRequest request)
        {
            var sb = new StringBuilder();
            sb.AppendLine("Analyze workforce performance and provide alerts and recommendations.");
            sb.AppendLine("Compare Planned vs Actual metrics (Attrition %, Shrinkage %, HC).");
            sb.AppendLine("Also analyze Staffing Delta = Available HC - Required HC, and Staffing% = (Available HC / Required HC)*100.\n");

            // Group data by LOB + Geo + Site
            var grouped = request.Data.GroupBy(d => new { d.SheetName, d.Geo, d.Site });

            foreach (var group in grouped)
            {
                sb.AppendLine($"LOB: {group.Key.SheetName} | Geo: {group.Key.Geo} | Site: {group.Key.Site}");

                // ------------------ Planned vs Actual Comparison ------------------
                var plannedMetrics = group.Where(g => g.Header.StartsWith("Planned", System.StringComparison.OrdinalIgnoreCase)).ToList();
                var actualMetrics = group.Where(g => g.Header.StartsWith("Actual", System.StringComparison.OrdinalIgnoreCase)).ToList();

                foreach (var planned in plannedMetrics)
                {
                    var metricBase = planned.Header.Replace("Planned", "").Trim();
                    var actual = actualMetrics.FirstOrDefault(a => a.Header.Contains(metricBase, System.StringComparison.OrdinalIgnoreCase));

                    if (actual == null)
                    {
                        sb.AppendLine($"- Metric: {planned.Header} (no Actual data to compare)");
                        continue;
                    }

                    sb.AppendLine($"- Metric: {metricBase}");
                    sb.AppendLine($"  Planned Trend: {string.Join(", ", planned.Values.Select(v => $"{v.Week}: {v.Value}"))}");
                    sb.AppendLine($"  Actual Trend:  {string.Join(", ", actual.Values.Select(v => $"{v.Week}: {v.Value}"))}");

                    var avgPlanned = planned.Values.Average(v => v.Value);
                    var avgActual = actual.Values.Average(v => v.Value);
                    var delta = avgActual - avgPlanned;

                    sb.AppendLine($"  Average Planned: {avgPlanned:F2}, Average Actual: {avgActual:F2}, Variance: {delta:+0.00;-0.00}%");
                    sb.AppendLine();
                }

                // ------------------ Staffing Delta & Staffing % ------------------
                var requiredHC = group.FirstOrDefault(x => x.Header.Equals("Required HC", System.StringComparison.OrdinalIgnoreCase));
                var availableHC = group.FirstOrDefault(x => x.Header.Equals("Available HC", System.StringComparison.OrdinalIgnoreCase));

                if (requiredHC != null && availableHC != null)
                {
                    sb.AppendLine("Derived Metrics:");
                    var derivedByWeek = new List<string>();

                    foreach (var week in requiredHC.Values.Select(v => v.Week))
                    {
                        var req = requiredHC.Values.FirstOrDefault(v => v.Week == week)?.Value ?? 0;
                        var avail = availableHC.Values.FirstOrDefault(v => v.Week == week)?.Value ?? 0;

                        var delta = avail - req;
                        var staffingPct = req != 0 ? (avail / req) * 100 : 0;

                        derivedByWeek.Add($"{week}: Delta={delta:F2}, Staffing%={staffingPct:F1}%");
                    }

                    sb.AppendLine("  " + string.Join(", ", derivedByWeek));

                    var avgDelta = availableHC.Values.Average(v => v.Value) - requiredHC.Values.Average(v => v.Value);
                    var avgStaffingPct = requiredHC.Values.Zip(availableHC.Values, (r, a) => r.Value != 0 ? (a.Value / r.Value) * 100 : 0).Average();

                    sb.AppendLine($"  Avg Delta: {avgDelta:F2}, Avg Staffing%: {avgStaffingPct:F1}%\n");
                    sb.AppendLine("Highlight staffing shortages or overcapacity and recommend resource actions.\n");
                }

                sb.AppendLine("Identify anomalies, declining performance, or forecast risks.\n");
            }

            return sb.ToString();
        }
    }

    // --------------------------- AI Service Interface ---------------------------

    public interface IAIAnalyzer
    {
        Task<List<AIInsight>> GenerateInsightsAsync(string aiInput);
    }

    public class OpenAIAIAnalyzer : IAIAnalyzer
    {
        private readonly HttpClient _httpClient;
        private readonly string _apiKey;

        public OpenAIAIAnalyzer(HttpClient httpClient, IConfiguration config)
        {
            _httpClient = httpClient;
            _apiKey = config["OpenAI:ApiKey"];
        }

        public async Task<List<AIInsight>> GenerateInsightsAsync(string aiInput)
        {
            var requestBody = new
            {
                model = "gpt-4-turbo",
                messages = new[]
                {
                    new { role = "system", content = "You are an expert in workforce and capacity planning analytics. Return structured JSON output with insights." },
                    new { role = "user", content = aiInput }
                },
                response_format = new { type = "json_object" }
            };

            var request = new HttpRequestMessage(HttpMethod.Post, "https://api.openai.com/v1/chat/completions");
            request.Headers.Add("Authorization", $"Bearer {_apiKey}");
            request.Content = JsonContent.Create(requestBody);

            var response = await _httpClient.SendAsync(request);
            response.EnsureSuccessStatusCode();

            var content = await response.Content.ReadAsStringAsync();

            using var doc = JsonDocument.Parse(content);
            var resultText = doc.RootElement
                .GetProperty("choices")[0]
                .GetProperty("message")
                .GetProperty("content")
                .GetString();

            try
            {
                var parsed = JsonSerializer.Deserialize<List<AIInsight>>(resultText);
                return parsed ?? new List<AIInsight>();
            }
            catch
            {
                return new List<AIInsight> { new AIInsight { Summary = resultText } };
            }
        }
    }

    // --------------------------- Controller ---------------------------

    [ApiController]
    [Route("api/[controller]")]
    public class PlannerAIController : ControllerBase
    {
        private readonly IAIAnalyzer _aiAnalyzer;

        public PlannerAIController(IAIAnalyzer aiAnalyzer)
        {
            _aiAnalyzer = aiAnalyzer;
        }

        [HttpPost("analyze")]
        public async Task<IActionResult> AnalyzePlannerData([FromBody] PlannerRequest request)
        {
            if (request == null || request.Data == null || !request.Data.Any())
                return BadRequest("Invalid or empty data.");

            var aiInput = AIDataFormatter.Transform(request);
            var insights = await _aiAnalyzer.GenerateInsightsAsync(aiInput);

            return Ok(new { success = true, insights });
        }
    }
}
