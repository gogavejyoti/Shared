<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Analytics | Executive Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #0f1016;
            --card-bg: #1a1c26;
            --accent: #3699FF;
            --text-main: #ffffff;
            --text-dim: #92929f;
            --border: rgba(255, 255, 255, 0.05);
            --danger: #f64e60;
            --success: #0bb783;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.88rem;
            margin: 0; padding-bottom: 40px;
        }

        /* --- Header & Filters --- */
        .control-ribbon {
            background: #15171f;
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
            margin-bottom: 30px;
            position: sticky;
            top: 0; z-index: 1000;
        }

        .filter-group label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 700;
            margin-bottom: 6px;
            display: block;
        }

        /* --- Bento Cards --- */
        .bento-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            height: 100%;
            transition: transform 0.2s ease;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* --- KPI Styling --- */
        .kpi-val { font-size: 2rem; font-weight: 700; display: block; }
        .kpi-sub { font-size: 0.75rem; color: var(--text-dim); }

        /* --- Select2 Dark Overrides --- */
        .select2-container--default .select2-selection--multiple {
            background-color: #0f1016 !important;
            border: 1px solid var(--border) !important;
            border-radius: 8px;
            min-height: 38px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: rgba(54, 153, 255, 0.1) !important;
            color: var(--accent) !important;
            border: 1px solid rgba(54, 153, 255, 0.2) !important;
            font-size: 11px;
        }
        .select2-dropdown { background-color: #1a1c26 !important; border: 1px solid var(--border) !important; }
        .select2-results__option { color: var(--text-dim); }

        /* --- Table Styling (Fixed Visibility) --- */
        #mainTable { width: 100% !important; border-collapse: separate; border-spacing: 0 8px; }
        #mainTable thead th { 
            color: var(--text-dim); 
            text-transform: uppercase; 
            font-size: 11px; 
            letter-spacing: 0.5px;
            border: none;
            padding: 12px;
        }
        #mainTable tbody tr { background: rgba(255,255,255,0.02); transition: 0.2s; }
        #mainTable tbody tr:hover { background: rgba(255,255,255,0.05); }
        #mainTable tbody td { 
            color: var(--text-main) !important; 
            padding: 15px 12px;
            border: none;
        }
        
        .drilldown-box {
            background: #111218;
            border-left: 3px solid var(--accent);
            padding: 20px;
            margin: 0 10px 10px 10px;
            border-radius: 0 0 12px 12px;
        }

        /* Remove the default DataTables control icon to avoid double icons */
        table.dataTable td.custom-drill { cursor: pointer; }
    </style>
</head>
<body>

    <div class="control-ribbon">
        <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h4 class="fw-bold mb-0">Workforce Intelligence <span class="badge bg-primary ms-2" style="font-size: 10px;">LIVE</span></h4>
                    <p class="text-muted small mb-0">Strategic Performance & Headcount Monitoring</p>
                </div>
                <button class="btn btn-primary btn-sm px-4 rounded-pill" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-2"></i> Update Board
                </button>
            </div>

            <div class="row g-2">
                <div class="col-lg-1 col-md-3 filter-group"><label>Week</label><select id="f-week" class="form-control select2" multiple></select></div>
                <div class="col-lg-2 col-md-3 filter-group"><label>Geo</label><select id="f-geo" class="form-control select2" multiple></select></div>
                <div class="col-lg-2 col-md-3 filter-group"><label>Client</label><select id="f-client" class="form-control select2" multiple></select></div>
                <div class="col-lg-1 col-md-3 filter-group"><label>Project</label><select id="f-project" class="form-control select2" multiple></select></div>
                <div class="col-lg-2 col-md-3 filter-group"><label>Program</label><select id="f-program" class="form-control select2" multiple></select></div>
                <div class="col-lg-1 col-md-3 filter-group"><label>OU</label><select id="f-ou" class="form-control select2" multiple></select></div>
                <div class="col-lg-2 col-md-3 filter-group"><label>Description</label><select id="f-desc" class="form-control select2" multiple></select></div>
                <div class="col-lg-1 col-md-3 filter-group"><label>Prj ID</label><select id="f-pid" class="form-control select2" multiple></select></div>
            </div>
        </div>
    </div>

    <div class="container-fluid px-4">
        
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="bento-card">
                    <span class="kpi-sub">Total Scheduled</span>
                    <span class="kpi-val" id="kpi-sch">0</span>
                    <div class="text-success small"><i class="fas fa-caret-up"></i> 1.2% from prev. wk</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bento-card">
                    <span class="kpi-sub">Actual Headcount</span>
                    <span class="kpi-val text-primary" id="kpi-act">0</span>
                    <div class="text-dim small">98.2% Fulfillment</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bento-card">
                    <span class="kpi-sub">Variance (Delta)</span>
                    <span class="kpi-val text-danger" id="kpi-delta">0</span>
                    <div class="text-dim small">Requires attention</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="bento-card">
                    <span class="kpi-sub">Billable Efficiency</span>
                    <span class="kpi-val text-success" id="kpi-bill">0%</span>
                    <div class="progress mt-2" style="height: 4px; background: #2a2c3a;">
                        <div class="progress-bar bg-success" style="width: 85%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="bento-card">
                    <div class="card-title">Performance Trend Analysis <i class="fas fa-ellipsis-v text-dim"></i></div>
                    <div id="chart-trend" style="height: 350px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="bento-card">
                    <div class="card-title">Regional Distribution <i class="fas fa-chart-pie text-dim"></i></div>
                    <div id="chart-geo" style="height: 350px;"></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-4">
                <div class="bento-card">
                    <div class="card-title">Project Variance Rank</div>
                    <div id="chart-bar" style="height: 280px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="bento-card">
                    <div class="card-title">Attrition & Exceptions</div>
                    <div id="chart-stacked" style="height: 280px;"></div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="bento-card">
                    <div class="card-title">Target Compliance</div>
                    <div id="chart-radial" style="height: 280px;"></div>
                </div>
            </div>
        </div>

        <div class="bento-card">
            <div class="card-title">Detailed Project Roster <button class="btn btn-sm btn-outline-secondary">Download CSV</button></div>
            <div class="table-responsive">
                <table id="mainTable" class="table">
                    <thead>
                        <tr>
                            <th style="width: 40px"></th>
                            <th>Week</th>
                            <th>Geo</th>
                            <th>Client</th>
                            <th>Project</th>
                            <th class="text-end">Sch HC</th>
                            <th class="text-end">Act HC</th>
                            <th class="text-center">Delta</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let trendChart, geoChart, barChart, stackedChart, radialChart;

        $(document).ready(function() {
            // Init Components
            $('.select2').select2({ width: '100%' });
            initCharts();
            initTable();
            
            // Initial Data Pull
            refreshData();

            // Trigger on filter change
            $('.select2').on('change', refreshData);
        });

        function refreshData() {
            const payload = {
                Weeks: $('#f-week').val(),
                Geos: $('#f-geo').val(),
                Clients: $('#f-client').val(),
                Projects: $('#f-project').val(),
                Programs: $('#f-program').val(),
                OUs: $('#f-ou').val(),
                Descriptions: $('#f-desc').val(),
                ProjectIDs: $('#f-pid').val()
            };

            // AJAX CALL TO YOUR MVC API
            $.ajax({
                url: '/api/Workforce/GetData', // Replace with your actual controller route
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    updateUI(response);
                },
                error: function() {
                    console.error("API Connection Failed. Check your MVC Controller.");
                    // Fallback to show empty state
                }
            });
        }

        function updateUI(data) {
            // 1. Update KPIs
            $('#kpi-sch').text(data.KPIs.TotalSch);
            $('#kpi-act').text(data.KPIs.TotalAct);
            $('#kpi-delta').text(data.KPIs.TotalDelta);
            $('#kpi-bill').text(data.KPIs.BillableRate + '%');

            // 2. Update Charts
            trendChart.updateSeries([
                { name: 'Scheduled', data: data.TrendChart.map(x => x.sch) },
                { name: 'Actual', data: data.TrendChart.map(x => x.act) }
            ]);

            geoChart.updateSeries(data.GeoChart.map(x => x.value));
            geoChart.updateOptions({ labels: data.GeoChart.map(x => x.label) });

            // 3. Update Table
            const dt = $('#mainTable').DataTable();
            dt.clear().rows.add(data.TableData).draw();
        }

        function initCharts() {
            const chartConfig = { theme: { mode: 'dark' }, chart: { toolbar: { show: false }, background: 'transparent' } };

            // 1. Trend Area
            trendChart = new ApexCharts(document.querySelector("#chart-trend"), {
                ...chartConfig,
                series: [],
                chart: { type: 'area', height: 350 },
                colors: ['#3699FF', '#0BB783'],
                stroke: { curve: 'smooth', width: 2 },
                xaxis: { categories: ['Wk1','Wk2','Wk3','Wk4','Wk5','Wk6','Wk7','Wk8'] }
            });
            trendChart.render();

            // 2. Geo Donut
            geoChart = new ApexCharts(document.querySelector("#chart-geo"), {
                ...chartConfig,
                series: [],
                chart: { type: 'donut', height: 350 },
                colors: ['#3699FF', '#8950FC', '#FFA800', '#F64E60'],
                legend: { position: 'bottom' }
            });
            geoChart.render();

            // 3. Bar Chart (Top Deltas)
            barChart = new ApexCharts(document.querySelector("#chart-bar"), {
                ...chartConfig,
                series: [{ name: 'Delta', data: [12, 9, 7, 5, 2] }],
                chart: { type: 'bar', height: 280 },
                plotOptions: { bar: { horizontal: true, borderRadius: 4 } },
                colors: ['#F64E60'],
                xaxis: { categories: ['Proj A', 'Proj B', 'Proj C', 'Proj D', 'Proj E'] }
            });
            barChart.render();

            // 4. Stacked Column
            stackedChart = new ApexCharts(document.querySelector("#chart-stacked"), {
                ...chartConfig,
                series: [{ name: 'Attrition', data: [2, 3, 1, 2] }, { name: 'TLOA', data: [1, 2, 0, 1] }],
                chart: { type: 'bar', stacked: true, height: 280 },
                colors: ['#FFA800', '#8950FC']
            });
            stackedChart.render();

            // 5. Radial Gauge
            radialChart = new ApexCharts(document.querySelector("#chart-radial"), {
                ...chartConfig,
                series: [85],
                chart: { type: 'radialBar', height: 280 },
                plotOptions: { radialBar: { hollow: { size: '70%' }, dataLabels: { value: { color: '#fff' } } } },
                colors: ['#0BB783']
            });
            radialChart.render();
        }

        function initTable() {
            const table = $('#mainTable').DataTable({
                columns: [
                    { 
                        className: 'custom-drill text-center', 
                        data: null, 
                        orderable: false,
                        defaultContent: '<i class="fas fa-plus-circle text-primary"></i>' 
                    },
                    { data: 'Week' },
                    { data: 'Geo' },
                    { data: 'Client' },
                    { data: 'Project' },
                    { data: 'SchHC', className: 'text-end' },
                    { data: 'ActSchHC', className: 'text-end' },
                    { 
                        data: 'Delta', 
                        className: 'text-center',
                        render: d => d > 0 ? `<span class="badge bg-danger bg-opacity-10 text-danger">${d}</span>` : `<span class="text-muted">-</span>`
                    }
                ],
                dom: 'rtp',
                pageLength: 5
            });

            // Drilldown Logic (Fixed)
            $('#mainTable tbody').on('click', 'td.custom-drill', function() {
                const tr = $(this).closest('tr');
                const row = table.row(tr);
                const icon = $(this).find('i');

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                    icon.removeClass('fa-minus-circle').addClass('fa-plus-circle');
                } else {
                    const d = row.data();
                    const content = `
                        <div class="drilldown-box">
                            <div class="row">
                                <div class="col-md-4"><label class="text-muted d-block small">PROGRAM</label><strong>${d.Program}</strong></div>
                                <div class="col-md-4"><label class="text-muted d-block small">OU DESCRIPTION</label><strong>${d.OUDescription}</strong></div>
                                <div class="col-md-4"><label class="text-muted d-block small">BILLABLE STATUS</label><span class="text-success">${d.BillableStatus}</span></div>
                            </div>
                        </div>`;
                    row.child(content).show();
                    tr.addClass('shown');
                    icon.removeClass('fa-plus-circle').addClass('fa-minus-circle');
                }
            });
        }
    </script>
</body>
</html>
