window.luckysheet_function.WEEKNUM.f = function (dateInput, returnType) {
    try {
        // Validate date
        let d = M.getCellDate(dateInput);
        if (H(d)) return d;

        let jsDate = new Date(d);
        if (isNaN(jsDate)) return p.error.v;

        // Default return type
        let type = 1;
        if (returnType !== undefined) {
            type = M.getFirstValue(returnType);
            if (!B(type)) return p.error.v;
            type = parseInt(type);
            if (type !== 1) return p.error.nm;  // Only Excel default supported here
        }

        // --- Excel WEEKNUM(date,1) logic ---
        // Convert to UTC to avoid timezone shift
        const utc = new Date(Date.UTC(
            jsDate.getFullYear(),
            jsDate.getMonth(),
            jsDate.getDate()
        ));

        // Sunday = 0
        const day = utc.getUTCDay();

        // Find Sunday of this week
        const sunday = new Date(utc);
        sunday.setUTCDate(utc.getUTCDate() - day);

        // Find first Sunday of the year
        const yearStart = new Date(Date.UTC(utc.getUTCFullYear(), 0, 1));
        const firstSunday = new Date(yearStart);
        firstSunday.setUTCDate(yearStart.getUTCDate() - yearStart.getUTCDay());

        // Calculate week number
        const msPerWeek = 7 * 24 * 60 * 60 * 1000;
        const weekNum = Math.floor((sunday - firstSunday) / msPerWeek) + 1;

        return weekNum;
    }
    catch (err) {
        err = p.errorInfo(err);
        return [p.error.v, err];
    }
};
