public class AiDashboardData
{
    public string ExecutiveSummary { get; set; }
    public List<LobInsight> Groups { get; set; }
}

public class LobInsight
{
    public string Lob { get; set; }
    public string Geo { get; set; }
    public string Site { get; set; }
    public double StaffingLevel { get; set; }
    public string Status { get; set; } // Stable, Warning, Critical
    public List<string> Alerts { get; set; }
    public List<string> Recommendations { get; set; }
}


public async Task<string> GetExtremeBeautifulReport(SummaryPlannerRequest request)
{
    // 1. Prepare the Data for AI
    var aiInput = TransformToAiJsonPrompt(request);
    
    // 2. Get JSON response from AI
    var rawJson = await GenerateInsightsAsync(aiInput);
    
    // 3. Clean and Parse the JSON
    // Note: AI sometimes adds ```json ... ``` blocks, we strip them.
    var cleanJson = rawJson.Replace("```json", "").Replace("```", "").Trim();
    var data = Newtonsoft.Json.JsonConvert.DeserializeObject<AiDashboardData>(cleanJson);
    
    // 4. Render the professional HTML
    return RenderDashboard(data);
}


public string TransformToAiJsonPrompt(SummaryPlannerRequest request)
{
    var sb = new StringBuilder();

    // 1. SYSTEM ROLE & OUTPUT CONTRACT
    sb.AppendLine("### ROLE ###");
    sb.AppendLine("You are a Senior Workforce Management (WFM) Analyst and Data Scientist.");
    sb.AppendLine("Analyze the provided capacity data and return ONLY a valid JSON object.");
    sb.AppendLine("Do not include conversational text or markdown code blocks (```json).");

    sb.AppendLine("\n### JSON STRUCTURE REQUIRED ###");
    sb.AppendLine(@"{
        ""executiveSummary"": ""A 2-3 sentence high-level summary of global capacity health, focusing on the most critical risks or successes across all regions."",
        ""groups"": [
            {
                ""lob"": ""LOB Name"",
                ""geo"": ""Geography"",
                ""site"": ""Site Name"",
                ""staffingLevel"": 0.0, 
                ""status"": ""Stable|Warning|Critical"", 
                ""alerts"": [""Specific trend alert"", ""Holiday impact alert""],
                ""recommendations"": [""Specific actionable step""]
            }
        ]
    }");

    // 2. LOGICAL RULES FOR THE AI
    sb.AppendLine("\n### ANALYTICAL RULES ###");
    sb.AppendLine($"- The 'Current Week' is defined as the week ending before {request.Weeks.NextWeek}.");
    sb.AppendLine($"- Recommendations must strictly focus on dates on or after {request.Weeks.NextWeek}.");
    sb.AppendLine("- STATUS LOGIC: 'Critical' if variance > 15%, 'Warning' if variance 10-15%, 'Stable' if < 10%.");
    sb.AppendLine("- HOLIDAY CHECK: Identify if shrinkage is identical across weeks (an error) or if upcoming holidays lack staffing adjustments.");

    // 3. DATA INJECTION
    sb.AppendLine("\n### DATASET ###");

    var grouped = request.Data.GroupBy(d => new { d.SheetName, d.Geo, d.Site });

    foreach (var group in grouped)
    {
        sb.AppendLine($"\n--- START LOB: {group.Key.SheetName} | GEO: {group.Key.Geo} | SITE: {group.Key.Site} ---");

        var plannedMetrics = group.Where(g => g.Header.StartsWith("Planned", StringComparison.OrdinalIgnoreCase)).ToList();
        var actualMetrics = group.Where(g => g.Header.StartsWith("Actual", StringComparison.OrdinalIgnoreCase)).ToList();
        var staffingPer = group.FirstOrDefault(x => x.Header.Equals("Staffing %", StringComparison.OrdinalIgnoreCase));

        // Inject Staffing % Trend
        if (staffingPer != null)
        {
            var trend = staffingPer.Values.Select(v => $"{v.Week}: {v.NumValue:P1}");
            sb.AppendLine($"- Staffing % History: {string.Join(", ", trend)}");
        }

        // Comparison of Planned vs Actuals
        foreach (var planned in plannedMetrics)
        {
            var metricBase = planned.Header.Replace("Planned", "").Trim();
            var actual = actualMetrics.FirstOrDefault(a => a.Header.Contains(metricBase, StringComparison.OrdinalIgnoreCase));
            
            if (actual != null)
            {
                var histActual = actual.Values
                    .Where(x => Convert.ToDateTime(x.Week) < Convert.ToDateTime(request.Weeks.NextWeek))
                    .Select(v => $"{v.Week}: {v.NumValue:N0}");
                
                var futPlanned = planned.Values
                    .Where(x => Convert.ToDateTime(x.Week) >= Convert.ToDateTime(request.Weeks.NextWeek))
                    .Select(v => $"{v.Week}: {v.NumValue:N0}");

                sb.AppendLine($"- Metric [{metricBase}] Actuals: {string.Join(", ", histActual)}");
                sb.AppendLine($"- Metric [{metricBase}] Planned: {string.Join(", ", futPlanned)}");
            }
        }
        sb.AppendLine("--- END LOB ---");
    }

    return sb.ToString();
}


public string RenderDashboard(AiDashboardData data)
{
    var html = new StringBuilder();
    html.Append(@"
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        :root { --primary: #4318FF; --secondary: #707EAE; --success: #05CD99; --warning: #FFB547; --danger: #EE5D50; --bg: #F4F7FE; }
        .db-body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); padding: 30px; color: #2B3674; }
        .hero { background: linear-gradient(135deg, #4318FF 0%, #B088FF 100%); border-radius: 20px; padding: 40px; color: white; margin-bottom: 30px; box-shadow: 0px 20px 40px rgba(67, 24, 255, 0.2); }
        .card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 24px; box-shadow: 0px 4px 15px rgba(0,0,0,0.03); border: 1px solid #E0E5F2; }
        .lob-title { font-size: 22px; font-weight: 700; margin: 0; }
        .site-badge { background: #F4F7FE; color: #707EAE; padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; }
        .status-pill { padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .Critical { background: #FFEEF0; color: var(--danger); }
        .Warning { background: #FFF9E6; color: var(--warning); }
        .Stable { background: #E6FAF5; color: var(--success); }
        .progress-container { margin: 20px 0; }
        .progress-bar { height: 10px; background: #EFF4FB; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 1s ease-in-out; }
        .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; border-top: 1px solid #F4F7FE; padding-top: 20px; }
        .item-list { font-size: 14px; line-height: 1.6; margin: 5px 0; color: #47548C; }
    </style>
    <div class='db-body'>");

    // Executive Summary
    html.Append($@"
        <div class='hero'>
            <div style='font-size: 12px; font-weight: 700; opacity: 0.8; letter-spacing: 1px; margin-bottom: 10px;'>ANALYTICS INSIGHTS</div>
            <div style='font-size: 24px; font-weight: 600; line-height: 1.4;'>{data.ExecutiveSummary}</div>
        </div>");

    // LOB Cards
    foreach (var group in data.Groups)
    {
        string statusColor = group.Status == "Stable" ? "var(--success)" : (group.Status == "Warning" ? "var(--warning)" : "var(--danger)");
        
        html.Append($@"
        <div class='card'>
            <div style='display:flex; justify-content:space-between; align-items:start;'>
                <div>
                    <h3 class='lob-title'>{group.Lob}</h3>
                    <div style='margin-top:5px;'><span class='site-badge'>{group.Geo}</span> <span class='site-badge'>{group.Site}</span></div>
                </div>
                <span class='status-pill {group.Status}'>{group.Status}</span>
            </div>

            <div class='progress-container'>
                <div style='display:flex; justify-content:space-between; font-size:13px; font-weight:700; margin-bottom:8px;'>
                    <span>STAFFING EFFICIENCY</span>
                    <span>{group.StaffingLevel}%</span>
                </div>
                <div class='progress-bar'>
                    <div class='progress-fill' style='width:{group.StaffingLevel}%; background:{statusColor};'></div>
                </div>
            </div>

            <div class='insight-grid'>
                <div>
                    <div style='font-size:11px; font-weight:800; color:var(--danger); margin-bottom:10px;'>KEY ALERTS</div>
                    {string.Join("", group.Alerts.Select(a => $"<div class='item-list'>⚠️ {a}</div>"))}
                </div>
                <div>
                    <div style='font-size:11px; font-weight:800; color:var(--primary); margin-bottom:10px;'>ACTION PLAN</div>
                    {string.Join("", group.Recommendations.Select(r => $"<div class='item-list'>• {r}</div>"))}
                </div>
            </div>
        </div>");
    }

    html.Append("</div>");
    return html.ToString();
}
