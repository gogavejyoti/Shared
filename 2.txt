(function ($) {
    $.fn.staffingSummaryPopup = function (options) {
        const settings = $.extend({
            data: [],
            weekStartDay: 'sunday'
        }, options);

        $('#analyticsModal').remove();

        if ($('#weekAnalyticsPopupStyles').length === 0) {
            $('head').append(`
            <style id="weekAnalyticsPopupStyles">
                #analyticsModal .table-wrapper {
                    overflow-x: auto;
                    overflow-y: auto;
                    max-height: 500px;
                    position: relative;
                    border: 1px solid #ccc;
                    background: #fff;
                }
                #analyticsModal table {
                    border-collapse: collapse;
                    width: max-content;
                    table-layout: auto;
                }
                #analyticsModal th,
                #analyticsModal td {
                    border-top: 1px solid #ddd;
                    padding: 8px;
                    text-align: center;
                    white-space: nowrap;
                    background: #fff;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                #analyticsModal thead th {
                    position: sticky;
                    top: 0;
                    background: #f1f1f1;
                    z-index: 6;
                }
                #analyticsModal thead th.sticky-left {
                    position: sticky;
                    top: 0;
                    left: 0;
                    background: #f1f1f1;
                    z-index: 7;
                    min-width: 120px;
                }
                #analyticsModal thead th.sticky-left-2 {
                    position: sticky;
                    top: 0;
                    left: 120px;
                    background: #f1f1f1;
                    z-index: 7;
                    min-width: 150px;
                }
                #analyticsModal tbody td.sticky-left {
                    position: sticky;
                    left: 0;
                    background: #f1f1f1;
                    z-index: 5;
                    min-width: 120px;
                }
                #analyticsModal tbody td.sticky-left-2 {
                    position: sticky;
                    left: 120px;
                    background: #f1f1f1;
                    z-index: 5;
                    min-width: 150px;
                }
                #analyticsModal .rag-red { color: red; font-weight: bold; }
                #analyticsModal .rag-amber { color: orange; font-weight: bold; }
                #analyticsModal .rag-green { color: green; font-weight: bold; }
                #analyticsModal .filter-container {
                    margin: 10px;
                }
            </style>
            `);
        }

        const modalHTML = `
        <div class="modal fade" id="analyticsModal" tabindex="-1" style="z-index:9999;zoom:85%">
          <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Staffing Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body p-0">
                <div class="filter-container">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <label><b>Filter LOB:</b></label><br/>
                            <select id="lobFilter" multiple class="form-select form-select-sm" style="min-width:200px;"></select>
                        </div>
                        <div class="col-auto">
                            <label><b>Filter Metrics:</b></label><br/>
                            <select id="metricFilter" multiple class="form-select form-select-sm" style="min-width:200px;">
                                <option value="Required HC" selected>Required HC</option>
                                <option value="Available HC" selected>Available HC</option>
                                <option value="Delta" selected>Delta</option>
                                <option value="Staffing %" selected>Staffing %</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <button id="applyFilterBtn" class="btn btn-primary btn-sm mt-3">Apply Filter</button>
                        </div>
                    </div>
                </div>
                <div class="table-wrapper" id="staffingContainer"></div>
              </div>
            </div>
          </div>
        </div>`;
        $('body').append(modalHTML);

        const $container = $('#staffingContainer');
        const parseWeek = w => {
            const [dd, mmm, yy] = w.split('-');
            const fullYear = yy.length === 2 ? (parseInt(yy, 10) < 50 ? '20' + yy : '19' + yy) : yy;
            return new Date(`${mmm} ${dd}, ${fullYear}`);
        };

        const uniqueWeeks = [...new Set(settings.data.map(d => d.week))]
            .sort((a, b) => parseWeek(a) - parseWeek(b));
        const uniqueLOBs = [...new Set(settings.data.map(d => d.sheetName))].sort();
        const metrics = ['Required HC', 'Available HC', 'Delta', 'Staffing %'];

        const groupedData = {};
        settings.data.forEach(d => {
            if (!groupedData[d.sheetName]) groupedData[d.sheetName] = {};
            if (!groupedData[d.sheetName][d.week]) groupedData[d.sheetName][d.week] = {};
            groupedData[d.sheetName][d.week][d.header] = Number(d.value);
        });

        uniqueLOBs.forEach(lob => {
            uniqueWeeks.forEach(week => {
                const req = groupedData[lob][week]?.['Required HC'] || 0;
                const avail = groupedData[lob][week]?.['Available HC'] || 0;
                groupedData[lob][week]['Delta'] = avail - req;
                groupedData[lob][week]['Staffing %'] = req === 0 ? 0 : Math.round((avail / req) * 100);
            });
        });

        const lobColors = ['#2c3e50', '#34495e', '#16a085', '#8e44ad', '#d35400', '#7f8c8d', '#27ae60', '#c0392b'];

        function lightenColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16),
                amt = Math.round(2.55 * percent),
                R = (num >> 16) + amt,
                G = (num >> 8 & 0x00FF) + amt,
                B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }

        // Populate LOB filter options
        uniqueLOBs.forEach(lob => {
            $('#lobFilter').append(`<option value="${lob}" selected>${lob}</option>`);
        });

        function buildTable(selectedLOBs, selectedMetrics) {
            let html = '<table><thead><tr>';
            html += `<th class="sticky-left">LOB</th>`;
            html += `<th class="sticky-left-2">Metric</th>`;
            uniqueWeeks.forEach(week => html += `<th>${week}</th>`);
            html += '</tr></thead><tbody>';

            selectedLOBs.forEach((lob, lobIndex) => {
                const lobColor = lobColors[lobIndex % lobColors.length];
                selectedMetrics.forEach((metric, i) => {
                    html += '<tr>';

                    if (i === 0) {
                        html += `<td class="sticky-left" rowspan="${selectedMetrics.length}" style="background:${lobColor}; color:#fff;">${lob}</td>`;
                    }

                    html += `<td class="sticky-left-2">${metric}</td>`;

                    uniqueWeeks.forEach(week => {
                        let val = (groupedData[lob][week] && groupedData[lob][week][metric]) || 0;
                        val = Math.round(val);

                        let cls = '';
                        if (metric === 'Delta' && val < 0) cls = 'rag-red';
                        if (metric === 'Staffing %') {
                            if (val < 80) cls = 'rag-red';
                            else if (val < 100) cls = 'rag-amber';
                            else cls = 'rag-green';
                            val = `${val}%`;
                        } else {
                            val = new Intl.NumberFormat().format(val);
                        }

                        html += `<td class="${cls}" title="${val}">${val}</td>`;
                    });

                    html += '</tr>';
                });
            });

            html += '</tbody></table>';
            $container.html(html);
        }

        $('#applyFilterBtn').on('click', function () {
            const selectedLOBs = $('#lobFilter').val() || [];
            const selectedMetrics = $('#metricFilter').val() || [];
            buildTable(selectedLOBs, selectedMetrics);
        });

        // Initial table build
        buildTable(uniqueLOBs, metrics);

        const modalEl = document.getElementById('analyticsModal');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();

        return this;
    };
})(jQuery);
