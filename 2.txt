function calcSimulated(d) {
    if (!d) return {};

    const shrinkInput = $toolbar.find('.sim-input-global-shrink').val();
    const attrInput = $toolbar.find('.sim-input-global-attr').val();

    const shrink = simulatedValues[`${d.lob}_${d.week}_shrink`] ?? 0;
    const attr = simulatedValues[`${d.lob}_${d.week}_attr`] ?? 0;

    const orig = originalMetrics[`${d.lob}_${d.week}`];
    let fteReq = null, fteAvail = null, delta = null, staffing = null;

    // Get previous week (if exists)
    const currentWeekIndex = weeks.indexOf(d.week);
    const prevWeek = currentWeekIndex > 0 ? weeks[currentWeekIndex - 1] : null;

    // Simulated FTE Required (same logic as before)
    if (shrinkInput)
        fteReq = d.fteRequired != null ? d.fteRequired * (1 - d.plannedShrinkage / 100) / (1 - shrink / 100) : null;
    else
        fteReq = d.fteRequired;

    // --- NEW LOGIC for FTE Available ---
    if (prevWeek) {
        // If previous simulated FTE Available exists, apply simulated attrition to it
        const prevKey = `${d.lob}_${prevWeek}_fteAvail`;
        const prevSimAvail = simulatedValues[prevKey];

        if (prevSimAvail != null && !isNaN(prevSimAvail)) {
            fteAvail = prevSimAvail * (1 - attr / 100);
        } else {
            // fallback to original
            fteAvail = d.fteAvailable != null ? d.fteAvailable * (1 - attr / 100) : null;
        }
    } else {
        // For first week, use original available
        fteAvail = d.fteAvailable != null ? d.fteAvailable * (1 - attr / 100) : null;
    }

    // Save simulated FTE Available for future week dependency
    simulatedValues[`${d.lob}_${d.week}_fteAvail`] = fteAvail;

    delta = fteReq != null && fteAvail != null ? fteAvail - fteReq : null;
    staffing = fteReq ? (fteAvail / fteReq * 100) : null;

    return {
        'FTE Required': fteReq,
        'FTE Available': fteAvail,
        'Delta': delta,
        'Staffing %': staffing,
        'Simulated Shrinkage %': shrink,
        'Simulated Attrition %': attr
    };
}
