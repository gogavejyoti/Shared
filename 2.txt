WEEKNUM: function () {
    if (arguments.length < 1 || arguments.length > 2)
        return p.error.na;

    try {
        var dateValue = M.getCellDate(arguments[0]);
        if (H(dateValue)) return dateValue;
        if (!(0, j.default)(dateValue).isValid()) return p.error.v;

        var jsDate = new Date(dateValue);

        // Default = Excel type 1
        var returnType = 1;
        if (arguments.length === 2) {
            returnType = parseInt(M.getFirstValue(arguments[1]));
            if (!B(returnType)) return p.error.v;
        }

        // ISO handled separately
        if (returnType === 21) {
            return window.luckysheet_function.ISOWEEKNUM.f(arguments[0]);
        }

        // Excel mapping: startDay (0=Sun...6=Sat)
        const startMap = {
            1: 0,  // Sunday
            2: 1,  // Monday
            11: 1, // Monday
            12: 2, // Tuesday
            13: 3,
            14: 4,
            15: 5,
            16: 6,
            17: 0  // Sunday
        };

        if (!(returnType in startMap))
            return p.error.nm;

        const weekStart = startMap[returnType];
        const msPerDay = 86400000;

        // Excel's rule: Week 1 includes Jan 1
        const yearStart = new Date(jsDate.getFullYear(), 0, 1);
        const yearStartDay = yearStart.getDay();

        // Shift day to custom starting day
        const shift = (yearStartDay - weekStart + 7) % 7;

        // First week start date
        const firstWeekStart = new Date(jsDate.getFullYear(), 0, 1 - shift);

        // Compute
        const weekNumber =
            Math.floor((jsDate - firstWeekStart) / (7 * msPerDay)) + 1;

        return weekNumber;

    } catch (err) {
        return [p.error.v, p.errorInfo(err)];
    }
}
