(function ($) {
    $.fn.weekAnalyticsPopup = function (options) {
        const settings = $.extend({
            data: [],
            weekStartDay: 'sunday'
        }, options);

        $('#analyticsModal').remove(); // Ensure previous modal is removed

        // Styles
        const styles = `
        <style>
            /* General Body adjustments for better font rendering */
            body {
                font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            /* Filter Section Styling */
            .filters {
                background-color: #f8f9fa !important; /* Lighter background */
                border: 1px solid #e0e0e0 !important;
                border-radius: 8px !important;
                padding: 20px !important;
                margin-bottom: 25px !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer shadow */
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 15px; /* Consistent spacing */
            }
            .filters label {
                margin-bottom: 0; /* Remove default label margin */
                font-weight: 500;
                color: #343a40;
                display: flex;
                align-items: center;
                gap: 8px; /* Space between label text and control */
            }
            .filters .form-select,
            .filters .btn {
                border-radius: 5px;
            }
            .filters .form-select {
                border: 1px solid #ced4da;
                padding: 0.375rem 1rem 0.375rem 0.75rem; /* Adjust padding for aesthetics */
                min-width: 150px; /* Ensure dropdowns have a minimum width */
            }

            /* Comparison Mode Switch */
            .form-check.form-switch {
                display: flex;
                align-items: center;
                gap: 8px;
                padding-left: 0; /* Remove default padding */
            }
            .form-check.form-switch .form-check-input {
                margin-left: 0; /* Align switch with text */
                flex-shrink: 0; /* Prevent input from shrinking */
                transform: scale(1.1); /* Slightly larger switch */
            }
            .form-check.form-switch .form-check-label {
                cursor: pointer;
                user-select: none;
            }

            /* Buttons */
            #applyFilter {
                background-color: #007bff;
                border-color: #007bff;
                font-weight: 600;
                padding: 8px 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            #applyFilter:hover {
                background-color: #0056b3;
                border-color: #0056b3;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            #exportCsv {
                background-color: #28a745;
                border-color: #28a745;
                font-weight: 600;
                padding: 8px 20px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            #exportCsv:hover {
                background-color: #1e7e34;
                border-color: #1e7e34;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }

            /* Chart Container */
            #chartsContainer {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* Responsive grid */
                gap: 25px; /* Increased gap for better separation */
                justify-items: center;
            }
            #chartsContainer canvas {
                width: 100% !important;
                max-width: 100%; /* Ensure canvas scales */
                height: 250px !important; /* Slightly taller charts */
            }

            /* Chart Card Styling */
            #chartsContainer .card {
                background: #ffffff; /* White background for cards */
                border: 1px solid #e9ecef; /* Lighter border */
                border-radius: 10px; /* More rounded corners */
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08); /* Enhanced shadow */
                transition: transform 0.2s ease-in-out;
            }
            #chartsContainer .card:hover {
                transform: translateY(-5px); /* Slight lift on hover */
            }
            #chartsContainer .card-title {
                color: #343a40;
                font-size: 1.15rem; /* Slightly larger title */
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 1px solid #f1f1f1; /* Subtle separator */
            }

            /* Custom Multi-select Styling */
            .custom-multiselect {
                width: 200px; /* Fixed width for consistency */
            }
            .custom-multiselect button {
                background-color: #ffffff;
                border-color: #ced4da;
                color: #495057;
                padding-right: 2.25rem; /* Space for dropdown arrow */
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .custom-multiselect button::after {
                margin-left: auto; /* Push arrow to the right */
            }
            .custom-multiselect .multiselect-options {
                border-color: #ced4da;
                border-radius: 5px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }
            .custom-multiselect .multiselect-options label {
                padding: 8px 12px;
                font-size: 0.95rem;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .custom-multiselect .multiselect-options label:hover {
                background-color: #e9ecef;
                color: #000;
            }

            /* Modal Header */
            .modal-header {
                background: linear-gradient(90deg, #007bff, #0056b3) !important; /* Darker blue gradient */
                color: #fff;
                border-bottom: none;
                border-top-left-radius: calc(0.5rem - 1px);
                border-top-right-radius: calc(0.5rem - 1px);
                padding: 1.5rem; /* More padding */
            }
            .modal-title {
                font-weight: 700;
                font-size: 1.75rem; /* Larger title */
            }
            .modal-content {
                border-radius: 0.5rem; /* Rounded modal corners */
                box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            }
            .btn-close {
                filter: invert(1); /* White close button */
                opacity: 0.8;
                transition: opacity 0.2s;
            }
            .btn-close:hover {
                opacity: 1;
            }

            /* Summary Table */
            .table-summary {
                margin-top: 30px !important;
                max-height: 300px; /* Increased height */
                border: 1px solid #e9ecef;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
            }
            .table-summary table {
                margin-bottom: 0;
            }
            .table-summary thead.table-primary {
                background-color: #007bff !important; /* Match primary blue */
                color: #fff;
            }
            .table-summary thead th {
                border-bottom: none;
                padding: 12px 15px;
                font-size: 0.95rem;
            }
            .table-summary tbody tr:hover {
                background-color: #f1f7fe; /* Light blue hover */
            }
            .table-summary tbody td {
                padding: 10px 15px;
                vertical-align: middle;
            }
            
            /* Loading Spinner */
            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.85); /* Slightly less transparent */
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1050;
                border-radius: .5rem; /* Match modal border radius */
            }
            .spinner-border {
                width: 3.5rem; /* Slightly larger spinner */
                height: 3.5rem;
                border-width: 0.3em; /* Thicker spinner */
            }

            /* Responsive Adjustments */
            @media (max-width: 768px) {
                .filters {
                    flex-direction: column;
                    align-items: stretch;
                }
                .filters label,
                .filters .custom-multiselect,
                .filters .form-select,
                .filters button {
                    width: 100% !important;
                }
                #chartsContainer {
                    grid-template-columns: 1fr; /* Single column on small screens */
                }
            }
        </style>`;
        $('head').append(styles);

        // Modal HTML (remains unchanged as per instructions)
        const modalHTML = `
        <div class="modal fade" id="analyticsModal" tabindex="-1">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content position-relative">
              <div class="loading-overlay d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div class="modal-header">
                <h5 class="modal-title">Workforce Analytics Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="filters mb-3 p-3 border rounded bg-light d-flex flex-wrap align-items-center gap-2">
                  <label>From Week: 
                    <select id="fromWeek" class="form-select d-inline-block w-auto"></select>
                  </label>
                  <label>To Week: 
                    <select id="toWeek" class="form-select d-inline-block w-auto"></select>
                  </label>
                  <label>LOB: 
                    <div class="custom-multiselect" id="lobSelectContainer">
                        <button type="button" class="btn btn-light dropdown-toggle" id="lobSelectBtn">Select LOBs</button>
                        <div class="multiselect-options"></div>
                    </div>
                  </label>
                  <label class="ms-2 form-check form-switch"><input class="form-check-input" type="checkbox" role="switch" id="comparisonMode"> Comparison Mode</label>
                  <button id="applyFilter" class="btn btn-primary btn-sm">Apply Filter</button>
                  <button id="exportCsv" class="btn btn-secondary btn-sm">Export CSV</button>
                </div>
                <div id="chartsContainer" class="mt-3"></div>
                <div id="analyticsSummary" class="mt-4 table-summary"></div>
              </div>
            </div>
          </div>
        </div>`;
        $('body').append(modalHTML);

        const $chartsContainer = $('#chartsContainer');
        const $analyticsSummary = $('#analyticsSummary');
        const $loadingOverlay = $('.loading-overlay');

        // Week parsing & formatting (unchanged)
        const parseWeek = (weekStr) => {
            const [dd, mmm, yy] = weekStr.split('-');
            return new Date(`${mmm} ${dd}, 20${yy}`);
        };
        const formatWeek = (date) => {
            const dd = String(date.getDate()).padStart(2, '0');
            const mmm = date.toLocaleString('default', { month: 'short' });
            const yy = String(date.getFullYear()).slice(-2);
            return `${dd}-${mmm}-${yy}`;
        };
        const getCurrentWeek = () => {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const diff = settings.weekStartDay === 'sunday' ? dayOfWeek : (dayOfWeek + 6) % 7;
            const lastWeekDate = new Date(today);
            lastWeekDate.setDate(today.getDate() - diff);
            return formatWeek(lastWeekDate);
        };

        // Data transform (unchanged)
        const structuredData = (() => {
            const grouped = {};
            settings.data.forEach(item => {
                if (!grouped[item.week]) grouped[item.week] = { Week: item.week };
                grouped[item.week][`${item.header}||${item.sheetName}`] = item.value;
            });
            return Object.values(grouped).sort((a, b) => parseWeek(a.Week) - parseWeek(b.Week));
        })();

        const uniqueLOBs = [...new Set(settings.data.map(d => d.sheetName))].sort();
        const uniqueHeaders = [...new Set(settings.data.map(d => d.header))].sort();
        const uniqueWeeks = [...new Set(settings.data.map(d => d.week))].sort((a, b) => parseWeek(a) - parseWeek(b));

        // Populate weeks (unchanged, only styling applied by CSS)
        uniqueWeeks.forEach(week => {
            $('#fromWeek').append(`<option value="${week}">${week}</option>`);
            $('#toWeek').append(`<option value="${week}">${week}</option>`);
        });
        const currentWeek = getCurrentWeek();
        const currentIndex = uniqueWeeks.indexOf(currentWeek);
        const fallbackIndex = currentIndex >= 0 ? currentIndex : uniqueWeeks.length - 1;
        const fromIndex = Math.max(0, fallbackIndex - 6);
        const toIndex = Math.min(uniqueWeeks.length - 1, fallbackIndex + 6);
        $('#fromWeek').val(uniqueWeeks[fromIndex]);
        $('#toWeek').val(uniqueWeeks[toIndex]);

        // Custom multi-select (logic unchanged, styling applied by CSS)
        const $lobContainer = $('#lobSelectContainer');
        const $lobBtn = $('#lobSelectBtn');
        const $optionsDiv = $lobContainer.find('.multiselect-options');
        uniqueLOBs.forEach(lob => $optionsDiv.append(`<label><input type="checkbox" value="${lob}"> ${lob}</label>`));

        $lobBtn.on('click', e => { e.stopPropagation(); $optionsDiv.toggle(); });
        $(document).on('click', () => $optionsDiv.hide());

        const getSelectedLOBs = () => {
            const selected = [];
            $optionsDiv.find('input:checked').each(function () { selected.push($(this).val()); });
            return selected.length ? selected : uniqueLOBs; // Select all if none chosen
        };

        $optionsDiv.find('input').on('change', function () {
            const selected = getSelectedLOBs();
            $lobBtn.text(selected.length === uniqueLOBs.length ? 'All LOBs Selected' : selected.join(', '));
            if (selected.length === 0) {
                $lobBtn.text('Select LOBs');
            }
        });
        $optionsDiv.find('input').prop('checked', true).trigger('change'); // Select all LOBs by default

        // Colors (slightly adjusted palette and added Staffing %)
        const metricColors = {
            "Required HC": "#007bff", "Available HC": "#28a745",
            "Actual Hours": "#17a2b8", "Forecasted Hours": "#ffc107",
            "Planned Shrinkage": "#6f42c1", "Actual Shrinkage": "#dc3545", // Changed actual shrinkage to red
            "Planned Attrition": "#e83e8c", "Actual Attrition": "#fd7e14", // Changed actual attrition to orange
            "Planned AHT": "#6610f2", "Actual AHT": "#20c997",
            "Staffing %": "#343a40" // Dark color for staffing line
        };
        const lobColors = {};
        const colorPalette = [
            '#007bff', '#28a745', '#fd7e14', '#6610f2', '#20c997',
            '#e83e8c', '#17a2b8', '#ffc107', '#6f42c1', '#dc3545',
            '#6c757d', '#adb5bd', '##00BFFF', '#7B68EE', '#FF69B4' // More diverse colors
        ];
        uniqueLOBs.forEach((lob, i) => lobColors[lob] = colorPalette[i % colorPalette.length]);

        // Filter data (unchanged)
        const filterData = () => {
            const fromWeek = $('#fromWeek').val();
            const toWeek = $('#toWeek').val();
            const selectedLOBs = getSelectedLOBs();
            const isComparison = $('#comparisonMode').is(':checked');
            const filtered = structuredData.filter(d => parseWeek(d.Week) >= parseWeek(fromWeek) && parseWeek(d.Week) <= parseWeek(toWeek));
            return { filtered, selectedLOBs, isComparison };
        };

        // Summary table with rounded numbers (minor aesthetic update)
        const generateSummary = (filtered, selectedLOBs) => {
            let html = `<div class="table-responsive"><table class="table table-striped table-hover"><thead class="table-primary"><tr><th>LOB</th><th>Metric</th><th>Total Value</th></tr></thead><tbody>`;
            if (filtered.length === 0) {
                html += `<tr><td colspan="3" class="text-center text-muted py-3">No data available for the selected filters.</td></tr>`;
            } else {
                selectedLOBs.forEach(lob => {
                    uniqueHeaders.forEach(header => {
                        let total = filtered.reduce((sum, d) => sum + Number(d[`${header}||${lob}`] || 0), 0);
                        let displayValue;
                        if (header.toLowerCase().includes('shrinkage') || header.toLowerCase().includes('attrition')) {
                            displayValue = total.toFixed(2) + '%';
                        } else if (header.toLowerCase().includes('aht')) {
                            displayValue = total.toFixed(1);
                        } else {
                            displayValue = Math.round(total).toLocaleString();
                        }
                        html += `<tr><td>${lob}</td><td>${header}</td><td>${displayValue}</td></tr>`;
                    });
                });
            }
            html += `</tbody></table></div>`;
            $analyticsSummary.html(html);
        };

        // Existing Chart.js instances to destroy before re-rendering
        let currentCharts = [];

        // Render charts (Chart.js options slightly tweaked for aesthetics)
        const renderCharts = (filtered, selectedLOBs, isComparison) => {
            $chartsContainer.empty();
            currentCharts.forEach(chart => chart.destroy());
            currentCharts = [];

            if (filtered.length === 0) {
                $chartsContainer.html('<p class="text-center text-muted p-4">No chart data available for the selected filters. Please adjust your week range or LOB selections.</p>');
                return;
            }

            const labels = filtered.map(d => d.Week);

            const createChart = (type, title, metrics, lobList, showPercent = false, includeStaffing = false, chartTypeOverride = null) => {
                const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`;
                $chartsContainer.append(`
                    <div class="card mb-4 shadow-sm border rounded bg-light" style="width:100%;">
                        <div class="card-body text-center">
                            <h6 class="card-title fw-bold">${title}</h6>
                            <canvas id="${chartId}"></canvas>
                        </div>
                    </div>
                `);
                const datasets = [];

                metrics.forEach(metric => {
                    lobList.forEach(lob => {
                        const isStaffingPercent = (metric === 'Staffing %');
                        const isPercentageMetric = showPercent && (metric.toLowerCase().includes('shrinkage') || metric.toLowerCase().includes('attrition'));

                        let data = filtered.map(d => {
                            if (isStaffingPercent) {
                                const availableHC = Number(d['Available HC||' + lob] || 0);
                                const requiredHC = Number(d['Required HC||' + lob] || 0);
                                return requiredHC > 0 ? (availableHC / requiredHC * 100) : 0;
                            }
                            if (isPercentageMetric) {
                                return (Number(d[`${metric}||${lob}`] || 0) * 100);
                            }
                            return Number(d[`${metric}||${lob}`] || 0);
                        });

                        datasets.push({
                            label: isStaffingPercent ? 'Staffing %' : `${lob} - ${metric}`,
                            data: data,
                            borderColor: isStaffingPercent ? metricColors['Staffing %'] : (isComparison ? lobColors[lob] : metricColors[metric]),
                            backgroundColor: isStaffingPercent ? 'rgba(52, 58, 64, 0.1)' : (isComparison ? lobColors[lob] + '55' : metricColors[metric] + '55'),
                            fill: (type === 'area' || isStaffingPercent) ? true : false,
                            borderDash: isStaffingPercent ? [5, 5] : [],
                            yAxisID: isStaffingPercent ? 'y1' : 'y',
                            type: chartTypeOverride || type,
                            pointRadius: 3, // Smaller points
                            pointHoverRadius: 5,
                            tension: 0.3 // Slightly smoother lines
                        });
                    });
                });

                const newChart = new Chart($(`#${chartId}`)[0].getContext('2d'), {
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    boxWidth: 15, // Smaller legend boxes
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        let val = context.raw;
                                        if (context.dataset.label.includes('Staffing %') || context.dataset.label.toLowerCase().includes('shrinkage') || context.dataset.label.toLowerCase().includes('attrition')) {
                                            return label + Number(val).toFixed(2) + '%';
                                        }
                                        return label + Number(val).toLocaleString();
                                    }
                                },
                                backgroundColor: 'rgba(0,0,0,0.8)', // Darker tooltip
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { font: { size: 11 } }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Value',
                                    font: { weight: 'bold', size: 13 },
                                    color: '#555'
                                },
                                ticks: {
                                    callback: function(value) { return Number(value).toLocaleString(); },
                                    font: { size: 11 }
                                },
                                grid: { color: '#e9ecef' } // Lighter grid lines
                            },
                            y1: {
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: includeStaffing,
                                    text: 'Staffing %',
                                    font: { weight: 'bold', size: 13 },
                                    color: '#555'
                                },
                                grid: { drawOnChartArea: false, color: '#e9ecef' },
                                ticks: {
                                    callback: function(value) { return value + '%'; },
                                    font: { size: 11 }
                                }
                            }
                        }
                    }
                });
                currentCharts.push(newChart);
            };

            if (isComparison) {
                selectedLOBs.forEach(lob => {
                     createChart('bar', `Headcount for ${lob}`, ['Required HC', 'Available HC'], [lob]);
                    createChart('line', `Hours for ${lob}`, ['Actual Hours', 'Forecasted Hours'], [lob]);
                    createChart('area', `Shrinkage % for ${lob}`, ['Planned Shrinkage', 'Actual Shrinkage'], [lob], true);
                    createChart('area', `Attrition % for ${lob}`, ['Planned Attrition', 'Actual Attrition'], [lob], true);
                    createChart('bar', `AHT for ${lob}`, ['Planned AHT', 'Actual AHT'], [lob]);
                });
            } else {
                if (selectedLOBs.length === 1) {
                    const singleLob = selectedLOBs[0];
                    // Mixed chart: HC as bar, Staffing % as line
                    createChart('bar', `Headcount & Staffing % for ${singleLob}`, ['Required HC', 'Available HC'], [singleLob], false, true, null); // Default to bar
                    createChart('line', `Staffing % (Line) for ${singleLob}`, ['Staffing %'], [singleLob], true, true, 'line'); // Separate line chart for staffing %
                    
                    createChart('line', `Hours for ${singleLob}`, ['Actual Hours', 'Forecasted Hours'], [singleLob]);
                    createChart('area', `Shrinkage % for ${singleLob}`, ['Planned Shrinkage', 'Actual Shrinkage'], [singleLob], true);
                    createChart('area', `Attrition % for ${singleLob}`, ['Planned Attrition', 'Actual Attrition'], [singleLob], true);
                    createChart('bar', `AHT for ${singleLob}`, ['Planned AHT', 'Actual AHT'], [singleLob]);
                } else {
                    // When multiple LOBs are selected in non-comparison mode, show metrics by LOB
                    uniqueHeaders.forEach(header => {
                        if (header === 'Required HC' || header === 'Available HC') return; 
                        if (header === 'Staffing %') {
                             createChart('line', `Staffing % Across LOBs`, ['Staffing %'], selectedLOBs, true, true, 'line');
                        } else {
                             createChart('bar', `${header} Across LOBs`, [header], selectedLOBs, header.toLowerCase().includes('shrinkage') || header.toLowerCase().includes('attrition'));
                        }
                    });
                     // Add a combined HC chart for multiple LOBs
                    createChart('bar', `Headcount (Required & Available) Across LOBs`, ['Required HC', 'Available HC'], selectedLOBs, false, false);
                }
            }
        };

        const exportCSV = (filtered, selectedLOBs) => {
            if (filtered.length === 0) {
                alert("No data to export for the current filters.");
                return;
            }

            let csv = '';
            const allHeaders = ['Week', ...uniqueHeaders.flatMap(h => selectedLOBs.map(l => `${h} (${l})`))];
            csv += allHeaders.map(header => `"${header.replace(/"/g, '""')}"`).join(',') + '\n';

            filtered.forEach(row => {
                const rowData = [];
                rowData.push(`"${row.Week}"`);
                uniqueHeaders.forEach(header => {
                    selectedLOBs.forEach(lob => {
                        let value = row[`${header}||${lob}`] || 0;
                        if (header === 'Staffing %') { // Calculate on the fly for export
                            const availableHC = Number(row['Available HC||' + lob] || 0);
                            const requiredHC = Number(row['Required HC||' + lob] || 0);
                            value = requiredHC > 0 ? (availableHC / requiredHC * 100).toFixed(2) + '%' : '0%';
                        } else if (header.toLowerCase().includes('shrinkage') || header.toLowerCase().includes('attrition')) {
                            value = (Number(value) * 100).toFixed(2) + '%';
                        } else if (header.toLowerCase().includes('aht')) {
                            value = Number(value).toFixed(1);
                        } else {
                             value = Number(value).toLocaleString();
                        }
                        rowData.push(`"${String(value).replace(/"/g, '""')}"`);
                    });
                });
                csv += rowData.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'workforce_analytics.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert("Your browser does not support downloading files directly. Please copy the data manually.");
            }
        };

        const applyFilters = () => {
            $loadingOverlay.removeClass('d-none');
            setTimeout(() => { // Simulate a small delay for loading effect
                const { filtered, selectedLOBs, isComparison } = filterData();
                renderCharts(filtered, selectedLOBs, isComparison);
                generateSummary(filtered, selectedLOBs);
                $loadingOverlay.addClass('d-none');
            }, 300); // Increased delay slightly for better visual effect
        };

        $('#applyFilter').off('click').on('click', applyFilters);
        $('#exportCsv').off('click').on('click', () => {
            const { filtered, selectedLOBs } = filterData();
            exportCSV(filtered, selectedLOBs);
        });

        // Trigger initial load
        applyFilters();
        $('#analyticsModal').modal('show');

        return this;
    };
})(jQuery);
