    public  class AIRecommendations
    {
        private readonly HttpClient _httpClient;
        private readonly IWebHostEnvironment _env;
        private readonly string _apiUrl;
        private readonly string _apiKey;
        private readonly IOptions<AppSettings> _settings;
        public AIRecommendations(IWebHostEnvironment env, IOptions<AppSettings> settings)
        {
            _env = env;
            _settings = settings;
            _httpClient = new HttpClient();
            _apiUrl = $"{_settings.Value.ChatGPTAPI.endpoint}openai/deployments/{_settings.Value.ChatGPTAPI.chatDeployment}/chat/completions?api-version={_settings.Value.ChatGPTAPI.chatApiVersion}";
            _apiKey = _settings.Value.ChatGPTAPI.apiKey;
            _httpClient.DefaultRequestHeaders.Add("api-key", _apiKey);
        }


        public string Transform(SummaryPlannerRequest request)
        {
            var sb = new StringBuilder();
            sb.AppendLine(@$"
 - Analyze the provided capacity dataset (Actual & Planned), broken down by LOB, Geo, Site, and Week.
 - Identify risks, anomalies, capacity shortages, overstaffing, deviations, and trend changes.
 - Mention specific geographies or LOBs with challenges.
- Consider region-specific holiday periods that may affect staffing, availability, SLAs, and productivity.
- Provide **clear alerts**, **trend-based insights**, and **actionable recommendations** that business users can take.
- Use concise, professional language.
- Please review shrinkage for upcoming geo-wise holiday period and ensure that shrinkage is not identical across all weeks.
- Future recommendations should apply to dates on or after ${request.Weeks.NextWeek} based on actual trends.
- Output must be in **HTML Inline styling** with inline svg images.
- Highlight important numbers and keywords with inline styles:
    - Green words (stable areas): style=""color: #27ae60; font-weight: bold;
    - Amber words (warnings): style=""color: #f39c12; font-weight: bold;
    - Red words (critical): style=""color: #e74c3c; font-weight: bold;
- Use a visually appealing illustrative theme.
Input:
");
            // Group data by LOB + Geo + Site
            var grouped = request.Data.GroupBy(d => new { d.SheetName, d.Geo, d.Site });
            sb.AppendLine(@$"   - <strong>Overall Assessment:</strong><br/>\r\n        
                                        - <Insert overall assessment text here (2–3 lines).>");

            foreach (var group in grouped)
            {
                sb.AppendLine($"LOB: {group.Key.SheetName} | Geo: {group.Key.Geo} | Site: {group.Key.Site}");

                // ------------------ Planned vs Actual Comparison ------------------
                var plannedMetrics = group.Where(g => g.Header.StartsWith("Planned", System.StringComparison.OrdinalIgnoreCase)).ToList();
                var actualMetrics = group.Where(g => g.Header.StartsWith("Actual", System.StringComparison.OrdinalIgnoreCase)).ToList();
                var staffingPer = group.FirstOrDefault(x => x.Header.Equals("Staffing %", System.StringComparison.OrdinalIgnoreCase));
                foreach (var planned in plannedMetrics)
                {
                    var metricBase = planned.Header.Replace("Planned", "").Trim();
                    var actual = actualMetrics.FirstOrDefault(a => a.Header.Contains(metricBase, System.StringComparison.OrdinalIgnoreCase));
                    if (actual == null)
                    {
                        sb.AppendLine($"- Metric: {planned.Header} (no Actual data to compare)");
                        continue;
                    }
                    sb.AppendLine($"- Metric: {metricBase}");
                    sb.AppendLine($"Actual Trend:  {string.Join(", ", actual.Values.Where(x => Convert.ToDateTime(x.Week) < Convert.ToDateTime(request.Weeks.NextWeek)).Select(v => $"{v.Week}: {(v.NumValue * 100).ToString("N2")}%"))}");
                    sb.AppendLine($"Planned : {string.Join(", ", planned.Values.Where(x => Convert.ToDateTime(x.Week) >= Convert.ToDateTime(request.Weeks.NextWeek)).Select(v => $"{v.Week}: {(v.NumValue * 100).ToString("N2")}%"))}");
                    sb.AppendLine($"Staffing% Trend: {string.Join(", ", staffingPer?.Values.Select(v => $"{v.Week}: {(v.NumValue).ToString("N2")}%"))}");
                    sb.AppendLine("<hr>");
                }
                



            }

            sb.AppendLine(@"
<div style='font-family:Arial; font-size:14px;'>
    <p><strong>Task:</strong></p>
    <p>For each LOB, summarize ONLY:</p>
    <ol>
        <li>Key Alerts (2 lines)</li>
        <li>Recommendations (1–2 lines)</li>
    </ol>
    <p><strong>Output Format (strict):</strong></p>
    <p>For each LOB:</p>
    <p>
        <strong>&lt;name&gt;</strong><br/>
        - Alerts:<br/>
        &nbsp;&nbsp;• &lt;Line 1 – biggest deviation&gt;<br/>
        &nbsp;&nbsp;• &lt;Line 2 – trend/holiday impact&gt;<br/>
        - Recommendations:<br/>
        &nbsp;&nbsp;• &lt;Line 1 – actionable step&gt;<br/>
        &nbsp;&nbsp;• &lt;Line 2 – optional optimization&gt;<br/>
    </p>
    <p><strong>Rules:</strong></p>
    <ul>
        <li>Max 5–6 lines per LOB.</li>
        <li>No tables, no long paragraphs.</li>
        <li>Keep it short, sharp, and decision-oriented.</li>
    </ul>
</div>
");

            return sb.ToString();
        }

        public  string Transform_(SummaryPlannerRequest request)
        {
            var sb = new StringBuilder();
            sb.AppendLine("Analyze workforce performance and provide alerts and recommendations for future planning based on actual trends.");
            sb.AppendLine("Compare Planned vs Actual metrics (Attrition %, Shrinkage %, HC).");
            sb.AppendLine("Also analyze Staffing Delta = Available HC - Required HC, and Staffing% = (Available HC / Required HC)*100.\n");

            // Group data by LOB + Geo + Site
            var grouped = request.Data.GroupBy(d => new { d.SheetName, d.Geo, d.Site });

            foreach (var group in grouped)
            {
                sb.AppendLine($"LOB: {group.Key.SheetName} | Geo: {group.Key.Geo} | Site: {group.Key.Site}");

                // ------------------ Planned vs Actual Comparison ------------------
                var plannedMetrics = group.Where(g => g.Header.StartsWith("Planned", System.StringComparison.OrdinalIgnoreCase)).ToList();
                var actualMetrics = group.Where(g => g.Header.StartsWith("Actual", System.StringComparison.OrdinalIgnoreCase)).ToList();

                foreach (var planned in plannedMetrics)
                {
                    var metricBase = planned.Header.Replace("Planned", "").Trim();
                    var actual = actualMetrics.FirstOrDefault(a => a.Header.Contains(metricBase, System.StringComparison.OrdinalIgnoreCase));

                    if (actual == null)
                    {
                        sb.AppendLine($"- Metric: {planned.Header} (no Actual data to compare)");
                        continue;
                    }

                    sb.AppendLine($"- Metric: {metricBase}");
                    sb.AppendLine($"  Planned Trend: {string.Join(", ", planned.Values.Select(v => $"{v.Week}: {v.Value}"))}");
                    sb.AppendLine($"  Actual Trend:  {string.Join(", ", actual.Values.Select(v => $"{v.Week}: {v.Value}"))}");

                    var avgPlanned = planned.Values.Average(v => v.NumValue);
                    var avgActual = actual.Values.Average(v => v.NumValue);
                    var delta = avgActual - avgPlanned;

                    sb.AppendLine($"  Average Planned: {avgPlanned:F2}, Average Actual: {avgActual:F2}, Variance: {delta:+0.00;-0.00}%");
                    sb.AppendLine();
                }

                // ------------------ Staffing Delta & Staffing % ------------------
                var requiredHC = group.FirstOrDefault(x => x.Header.Equals("Required HC", System.StringComparison.OrdinalIgnoreCase));
                var availableHC = group.FirstOrDefault(x => x.Header.Equals("Available HC", System.StringComparison.OrdinalIgnoreCase));

                if (requiredHC != null && availableHC != null)
                {
                    sb.AppendLine("Derived Metrics:");
                    var derivedByWeek = new List<string>();

                    foreach (var week in requiredHC.Values.Select(v => v.Week))
                    {
                        var req = requiredHC.Values.FirstOrDefault(v => v.Week == week)?.NumValue ?? 0;
                        var avail = availableHC.Values.FirstOrDefault(v => v.Week == week)?.NumValue ?? 0;

                        var delta = avail - req;
                        var staffingPct = req != 0 ? (avail / req) * 100 : 0;

                        derivedByWeek.Add($"{week}: Delta={delta:F2}, Staffing%={staffingPct:F1}%");
                    }

                    sb.AppendLine("  " + string.Join(", ", derivedByWeek));

                    var avgDelta = availableHC.Values.Average(v => v.NumValue) - requiredHC.Values.Average(v => v.NumValue);
                    var avgStaffingPct = requiredHC.Values.Zip(availableHC.Values, (r, a) => r.NumValue != 0 ? (a.NumValue / r.NumValue) * 100 : 0).Average();

                    sb.AppendLine($"  Avg Delta: {avgDelta:F2}, Avg Staffing%: {avgStaffingPct:F1}%\n");
                    sb.AppendLine("Highlight staffing shortages or overcapacity and recommend resource actions.\n");
                }

                sb.AppendLine("Identify anomalies, declining performance, or forecast risks.\n");
            }

            return sb.ToString();
        }

        public async Task<string> GenerateInsightsAsync(string aiInput)
        {
            var requestBody = new
            {
                messages = new[]
                {
                    new { role = "system", content = "You are an advanced Capacity Planning & Workforce Optimization Expert." },
                    new { role = "user", content = aiInput }
                },
            };
            using var http = new HttpClient();
            http.DefaultRequestHeaders.Add("api-key", _apiKey);

            var url = _apiUrl;
            var content = new StringContent(Newtonsoft.Json.JsonConvert.SerializeObject(requestBody), Encoding.UTF8, "application/json");
            var response = await http.PostAsync(url, content);
            var responseJson = await response.Content.ReadAsStringAsync();
            using var doc = JsonDocument.Parse(responseJson);
            var resultText = doc.RootElement
                .GetProperty("choices")[0]
                .GetProperty("message")
                .GetProperty("content")
                .GetString();
            return resultText;
        }

    }



looking output in below format please suggest prompt accordigly

<div style="font-family:Arial; font-size:14px; background: #f4f8fb; padding:20px; border-radius: 12px;">

<!-- SVG Decorative Header -->
<div style="display: flex; align-items: center; margin-bottom: 10px;">
  <svg width="32" height="32" viewBox="0 0 32 32" style="margin-right:10px;">
    <circle cx="16" cy="16" r="16" fill="#e3f6e8"></circle>
    <path d="M10 21 L16 13 L22 21" stroke="#27ae60" stroke-width="2" fill="none"></path>
    <circle cx="16" cy="21" r="2" fill="#27ae60"></circle>
  </svg>
  <span style="font-size:18px; color:#34495e; font-weight:bold;">Capacity Risk &amp; Staffing Optimization: Key LOB Summaries</span>
</div>

<div><strong>Overall Assessment:</strong><br>
<span style="color:#27ae60; font-weight:bold;">Both LOBs remain overstaffed</span> with actual staffing consistently above 100%. <span style="color:#f39c12; font-weight:bold;">Holiday shrinkage planning is flat except for peaks, masking true absenteeism risks</span> near major holiday periods.</div>

<hr style="margin:16px 0;">

<!-- IND R1 Lanco -->
<div style="margin-bottom:22px;">
  <strong>IND R1 Lanco | India | Hyderabad</strong><br>
  - Alerts:<br>
  &nbsp;&nbsp;• <span style="color: #e74c3c; font-weight: bold;">Attrition volatility observed</span> (spiking to <span style="color: #e74c3c; font-weight: bold;">6.02%</span> on 14-Sep), then dropping to <span style="color: #27ae60; font-weight: bold;">0.71%</span> by mid-Nov, suggesting a <svg width="13" height="13" style="margin-bottom:-2px"><polyline points="2,11 7,2 11,11" style="fill:none;stroke:#27ae60;stroke-width:2"></polyline></svg> declining trend.<br>
  &nbsp;&nbsp;• <span style="color: #f39c12; font-weight: bold;">Shrinkage planning is inconsistent over the holiday period</span> (sudden rises on <span style="color: #e74c3c; font-weight: bold;">21-Dec, 28-Dec, 11-Jan</span> at <span style="color: #e74c3c; font-weight: bold;">16.00%</span>), not reflecting week-on-week regional holiday patterns.<br>
  - Recommendations:<br>
  &nbsp;&nbsp;• <span style="color: #f39c12; font-weight: bold;">Refine shrinkage forecasts using recent trends and local holiday mapping</span> for weeks on/after <span style="font-weight:bold;">23-Nov-25</span>.<br>
  &nbsp;&nbsp;• Proactively monitor upcoming FTE demand for post-holiday weeks to avoid <span style="color: #f39c12; font-weight: bold;">overstaffing</span> (&gt;100%) and attrition-driven gaps.
</div>

<!-- IND R2 Lanco -->
<div style="margin-bottom:22px;">
  <strong>IND R2 Lanco | India | Hyderabad</strong><br>
  - Alerts:<br>
  &nbsp;&nbsp;• <span style="color: #27ae60; font-weight: bold;">Staffing remains strongly above required</span> (Actual up to <span style="color: #27ae60; font-weight: bold;">117.10%</span> in Nov), with <span style="color: #e74c3c; font-weight: bold;">attrition spiking</span> on <span style="color: #e74c3c; font-weight: bold;">26-Oct (5.94%)</span> then flattening.<br>
  &nbsp;&nbsp;• <span style="color: #f39c12; font-weight: bold;">Shrinkage plans flat except for sudden holiday peaks</span> (<span style="color: #e74c3c; font-weight: bold;">16.00%</span> in late Dec/Jan), risking <span style="color:#e74c3c; font-weight: bold;">underestimation</span> of absence variability.<br>
  - Recommendations:<br>
  &nbsp;&nbsp;• <span style="color: #f39c12; font-weight: bold;">Adjust shrinkage plans per geo-specific leave histories</span> and anticipated absence patterns.<br>
  &nbsp;&nbsp;• Consider <span style="color: #f39c12; font-weight: bold;">redeployment or flexible allocation</span> post-holiday to address sustained overstaffing and flatten attrition impact.
</div>

<!-- SVG Footer Divider -->
<div style="display:flex; align-items:center; margin-top:18px;">
  <svg width="100%" height="8" style="vertical-align:middle;">
    <rect width="100%" height="8" fill="#e3f6e8"></rect>
    <rect width="65%" height="8" fill="#27ae60"></rect>
  </svg>
</div>
</div>


