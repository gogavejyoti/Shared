public string Transform(SummaryPlannerRequest request)
{
    if (request == null) throw new ArgumentNullException(nameof(request));
    if (request.Weeks == null) throw new ArgumentNullException(nameof(request.Weeks));
    if (string.IsNullOrWhiteSpace(request.Weeks.NextWeek)) throw new ArgumentException("Weeks.NextWeek must be provided", nameof(request));

    var sb = new StringBuilder();

    // --- Header / Prompt instructions (infographic / Napkin-style) ---
    sb.AppendLine(@$"You are an Infographic-Style Analytical Assistant that outputs a single HTML block (inline CSS + inline SVG) suitable for embedding directly in a dashboard or email.
Produce concise, decision-oriented content only (no tables, no JSON, no code blocks). Adhere to the exact color-coded highlights shown below.

Rules:
- Analyze the provided capacity dataset (Actual & Planned), grouped by LOB, Geo, Site and Week.
- Use Actual data from weeks < {request.Weeks.NextWeek} and Planned data for weeks >= {request.Weeks.NextWeek}.
- Identify risks, anomalies, shortages, overstaffing, deviations, and trend changes.
- Call out geography- or site-specific holiday/shrinkage impacts; ensure shrinkage is not identical across holiday weeks.
- Provide only: Overall Assessment (2-3 lines) + For each LOB: Alerts (max 5-6 lines) and Recommendations (1-2 lines).
- Output MUST be HTML with inline CSS and inline SVG icons, max-width:100%, and visually carded (Napkin-style).
- Highlight using EXACT inline styles:
    - Stable (green): <span style=""color:#27ae60;font-weight:bold;"">text</span>
    - Warning (amber): <span style=""color:#f39c12;font-weight:bold;"">text</span>
    - Critical (red): <span style=""color:#e74c3c;font-weight:bold;"">text</span>
- Future recommendations must apply to dates on or after {request.Weeks.NextWeek}.
- Avoid long paragraphs — use bullets. No tables. Short, sharp lines only.

Input (summary form follows):");
    sb.AppendLine();

    // --- Provide a concise overall summary placeholder ---
    sb.AppendLine(@"<div style='font-family:Arial, sans-serif; font-size:14px; max-width:100%; background:#f6f7f9; padding:18px; border-radius:12px;'>");
    sb.AppendLine("  <!-- High-level summary card -->");
    sb.AppendLine("  <div style='background:white; padding:16px; border-radius:10px; box-shadow:0 6px 16px rgba(16,24,40,0.06); margin-bottom:16px;'>");
    sb.AppendLine("    <div style='display:flex; align-items:center; gap:10px;'>");
    sb.AppendLine("      <svg width='28' height='28' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>");
    sb.AppendLine("        <circle cx='12' cy='12' r='10' fill='#4a90e2' />");
    sb.AppendLine("        <path d='M12 7v5l3 2' stroke='white' stroke-width='2' fill='none' />");
    sb.AppendLine("      </svg>");
    sb.AppendLine("      <h3 style='margin:0; font-size:18px;'>Overall Assessment</h3>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <p style='margin-top:10px; line-height:1.5;'>");
    sb.AppendLine("      • <Insert concise 2–3 line overall assessment here>. <br/>");
    sb.AppendLine("      • <Top geo/LOB risks & immediate callouts>. <br/>");
    sb.AppendLine("    </p>");
    sb.AppendLine("  </div>");

    // --- Group data by LOB + Geo + Site and emit summary snippets for each group ---
    var grouped = (request.Data ?? Enumerable.Empty<PlannerDatum>())
                   .GroupBy(d => new { d.SheetName, d.Geo, d.Site })
                   .OrderBy(g => g.Key.SheetName).ThenBy(g => g.Key.Geo).ThenBy(g => g.Key.Site);

    foreach (var group in grouped)
    {
        // header for LOB/Geo/Site
        sb.AppendLine($"  <!-- LOB block: {group.Key.SheetName} • Geo: {group.Key.Geo} • Site: {group.Key.Site} -->");
        sb.AppendLine("  <div style='margin-top:14px;'>");
        sb.AppendLine($"    <h4 style='margin:0 0 8px 0; font-size:15px;'>LOB: <strong>{HtmlEncode(group.Key.SheetName)}</strong> &nbsp;•&nbsp; Geo: <strong>{HtmlEncode(group.Key.Geo)}</strong> &nbsp;•&nbsp; Site: <strong>{HtmlEncode(group.Key.Site)}</strong></h4>");

        // find metrics
        var plannedMetrics = group.Where(g => g.Header != null && g.Header.StartsWith("Planned", StringComparison.OrdinalIgnoreCase)).ToList();
        var actualMetrics = group.Where(g => g.Header != null && g.Header.StartsWith("Actual", StringComparison.OrdinalIgnoreCase)).ToList();
        var staffingPer = group.FirstOrDefault(x => string.Equals(x.Header, "Staffing %", StringComparison.OrdinalIgnoreCase));

        // small helper for per-metric rendering
        foreach (var planned in plannedMetrics)
        {
            var metricBase = planned.Header.Replace("Planned", "").Trim();
            var actual = actualMetrics.FirstOrDefault(a => a.Header != null && a.Header.IndexOf(metricBase, StringComparison.OrdinalIgnoreCase) >= 0);

            sb.AppendLine("    <div style='background:white; padding:12px; border-radius:10px; box-shadow:0 4px 12px rgba(16,24,40,0.04); margin-bottom:10px;'>");
            sb.AppendLine($"      <div style='font-weight:600; margin-bottom:8px;'>{HtmlEncode(metricBase)}</div>");

            if (actual == null)
            {
                sb.AppendLine($"      <div style='color:#e74c3c;font-weight:bold;'>• No Actual data available to compare for <strong>{HtmlEncode(planned.Header)}</strong>.</div>");
                sb.AppendLine("    </div>");
                continue;
            }

            // Actual trend for weeks before NextWeek
            var actualTrend = actual.Values
                .Where(x => SafeParseDate(x.Week) < SafeParseDate(request.Weeks.NextWeek))
                .Select(v => $"{v.Week}: {(v.NumValue * 100):N2}%");
            // Planned values from NextWeek onward
            var plannedTrend = planned.Values
                .Where(x => SafeParseDate(x.Week) >= SafeParseDate(request.Weeks.NextWeek))
                .Select(v => $"{v.Week}: {(v.NumValue * 100):N2}%");
            // Staffing%
            var staffingTrendText = staffingPer?.Values
                .Select(v => $"{v.Week}: {v.NumValue:N2}%") ?? Enumerable.Empty<string>();

            sb.AppendLine("      <div style='font-size:13px; line-height:1.45;'>");
            sb.AppendLine($"        • Actual Trend: {HtmlEncode(string.Join(", ", actualTrend))}<br/>");
            sb.AppendLine($"        • Planned: {HtmlEncode(string.Join(", ", plannedTrend))}<br/>");
            sb.AppendLine($"        • Staffing% Trend: {HtmlEncode(string.Join(", ", staffingTrendText))}<br/>");
            sb.AppendLine("      </div>");

            sb.AppendLine("    </div>");
        }

        // If no planned metrics found, emit a simple note
        if (!plannedMetrics.Any())
        {
            sb.AppendLine("    <div style='background:white; padding:12px; border-radius:10px; box-shadow:0 4px 12px rgba(16,24,40,0.04); margin-bottom:10px;'>");
            sb.AppendLine("      <div style='color:#f39c12;font-weight:bold;'>• No Planned metrics found for this LOB/Geo/Site — please verify sheet headers.</div>");
            sb.AppendLine("    </div>");
        }

        // After metric snippets, add the concise Alerts + Recommendations template the model should fill
        sb.AppendLine("    <!-- Alerts + Recommendations template for the model to populate -->");
        sb.AppendLine("    <div style='display:flex; gap:12px; margin-top:8px;'>");

        // Alerts card (left)
        sb.AppendLine("      <div style='flex:1; background:#fff; padding:12px; border-radius:10px; box-shadow:0 4px 12px rgba(16,24,40,0.04);'>");
        sb.AppendLine("        <div style='display:flex; align-items:center; gap:8px; margin-bottom:8px;'>");
        sb.AppendLine("          <svg width='20' height='20' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>");
        sb.AppendLine("            <circle cx='12' cy='12' r='10' fill='#f39c12'/>");
        sb.AppendLine("            <rect x='11' y='6' width='2' height='8' fill='white' />");
        sb.AppendLine("            <rect x='11' y='15.5' width='2' height='2' fill='white' />");
        sb.AppendLine("          </svg>");
        sb.AppendLine("          <strong>Alerts (max 5–6 lines)</strong>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div style='line-height:1.45; font-size:13px;'>");
        sb.AppendLine("          • <Model: list top deviations, holiday/shrinkage impact, SLA risk, and immediate critical weeks.> <br/>");
        sb.AppendLine("        </div>");
        sb.AppendLine("      </div>");

        // Recommendations card (right)
        sb.AppendLine("      <div style='width:340px; background:#fff; padding:12px; border-radius:10px; box-shadow:0 4px 12px rgba(16,24,40,0.04);'>");
        sb.AppendLine("        <div style='display:flex; align-items:center; gap:8px; margin-bottom:8px;'>");
        sb.AppendLine("          <svg width='20' height='20' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>");
        sb.AppendLine("            <circle cx='12' cy='12' r='10' fill='#27ae60'/>");
        sb.AppendLine("            <path d='M7 12l3 3 7-7' stroke='white' stroke-width='2' fill='none'/>");
        sb.AppendLine("          </svg>");
        sb.AppendLine("          <strong>Recommendations (1–2 lines)</strong>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div style='line-height:1.45; font-size:13px;'>");
        sb.AppendLine("          • <Model: concise, date-aware actionable step for weeks >= " + HtmlEncode(request.Weeks.NextWeek) + ">. <br/>");
        sb.AppendLine("          • <Model: optional optimization or cross-LOB shift.> <br/>");
        sb.AppendLine("        </div>");
        sb.AppendLine("      </div>");

        sb.AppendLine("    </div>"); // end flex
        sb.AppendLine("  </div>"); // end LOB block
    }

    // --- Final instructions / strict format reminder to model ---
    sb.AppendLine(@"
  <div style='margin-top:18px; font-size:13px;'>
    <strong>Final Output Rules (strict):</strong>
    <ul>
      <li>Return only the filled HTML block — no extra commentary, no code fences.</li>
      <li>Keep each LOB section to a maximum of 5–6 bullet lines for Alerts and max 2 short lines for Recommendations.</li>
      <li>All highlights MUST use the exact inline styles specified earlier.</li>
      <li>All recommended actions must reference dates >= the NextWeek date shown above.</li>
    </ul>
  </div>
</div>
");

    return sb.ToString();
}

/// <summary>
/// Utility: HTML-encode minimal strings to avoid breaking HTML output.
/// </summary>
private static string HtmlEncode(string input)
{
    if (string.IsNullOrEmpty(input)) return string.Empty;
    return System.Net.WebUtility.HtmlEncode(input);
}

/// <summary>
/// Utility: safely parse dates used inside planner weeks; fallback to DateTime.MaxValue if parse fails.
/// </summary>
private static DateTime SafeParseDate(string week)
{
    if (string.IsNullOrWhiteSpace(week)) return DateTime.MaxValue;
    if (DateTime.TryParse(week, out var dt)) return dt;
    // Try common alternate formats if needed — simple fallback:
    return DateTime.MaxValue;
}
