(function ($) {
    $.fn.versionComparison = function (options) {
        const settings = $.extend({
            data: [],
            processData: null,
            transformData: null,
            // JSON array
        }, options);

        // Remove old modal & styles (clean start)
        $('#versionComparisonModal').remove();
        $('#versionComparisonModalStyles').remove();

        // Inject CSS (fixed & cleaned) - NOTE: no top scrollbar CSS now
        $('head').append(`
            <style id="versionComparisonModalStyles">
                /* Modal Content Styling */
                #versionComparisonModal .modal-content { border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); font-family: 'Inter', sans-serif; background: #fafafa; }
                #versionComparisonModal .modal-header { border-bottom: 1px solid #e0e0e0; background-color: #D7C4F0; color: #2c2c2c; }
                #versionComparisonModal .modal-title { font-weight: 600; color: #2c2c2c; }
                #versionComparisonModal .btn-close { filter: invert(30%); }

                /* Table outer wrappers */
                .vc-table-outer { position: relative; margin: 10px; }

                /* Table wrapper (bottom) - this is the single scroll container */
                #versionComparisonModal .table-wrapper {
                    overflow-x: auto;
                    overflow-y: auto;
                    max-height: calc(100vh - 160px);
                    position: relative;
                    border: 1px solid #dcdcdc;
                    background: #fff;
                    border-radius: 8px;
                    margin: 0;
                    min-height: 200px;
                    padding-bottom: 12px; /* ensures bottom scrollbar stays visible */
                }

                /* Table */
                #versionComparisonModal table { border-collapse: collapse; width: max-content; table-layout: auto; }
                #versionComparisonModal th, #versionComparisonModal td { padding: 8px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-top: 1px solid #eaeaea; background: #fff; }

                /* Week/Highlight */
                #versionComparisonModal .cell-manual-sim { background: #DDF4E7 !important; }
                #versionComparisonModal .week-cell { background: blueviolet !important; color: #fff !important; }

                /* Sticky Header (higher z-index than sticky columns) */
                #versionComparisonModal thead th {
                    position: sticky;
                    top: 0;
                    background: #f5f5f5;
                    z-index: 20;
                }

                /* Sticky left columns placeholders (left value set by JS for exact widths) */
                #versionComparisonModal .sticky-1 { position: sticky; left: 0; background: #f0f0f0; z-index: 18; min-width: 140px; }
                #versionComparisonModal .sticky-2 { position: sticky; left: 140px; background: #f0f0f0; z-index: 18; min-width: 150px; }

                /* Body sticky cells */
                #versionComparisonModal tbody td.sticky-1 { position: sticky; left: 0; background: #f8f9fa; z-index: 16; min-width: 140px; }
                #versionComparisonModal tbody td.sticky-2 { position: sticky; left: 140px; background: #f8f9fa; z-index: 16; min-width: 150px; }

                /* Conditional Coloring */
                #versionComparisonModal .rag-red { color: #e74c3c; font-weight: bold; }
                #versionComparisonModal .rag-amber { color: #f39c12; font-weight: bold; }
                #versionComparisonModal .rag-green { color: #27ae60; font-weight: bold; }

                /* Filter Container */
                #versionComparisonModal .sticky-col{ background: gray !important; color: #fff !important;border-right: 1px solid #fff !important;}
                #versionComparisonModal .filter-container { margin: 10px; font-size: 0.875rem; }
                #versionComparisonModal .dropdown-checkbox { max-height: 250px; overflow-y: auto; padding: 10px; }

                /* Buttons */
                #versionComparisonModal .btn-sm { border-radius: 6px; font-size: 0.875rem; }
                #applyFilterBtn { background: #9b59b6; border-color: #9b59b6; }
                #applyFilterBtn:hover { background: #8e44ad; border-color: #8e44ad; }

                /* small helpers */
                .text-right { text-align: right; }
                .font-bold { font-weight: 700; }
                .font-semibold { font-weight: 600; }
            </style>
        `);

        // Build modal HTML (keeps your filter UI structure intact)
        const modalHTML = `
        <div class="modal fade" id="versionComparisonModal" tabindex="-1" style="z-index:9999;zoom:85%">
          <div class="modal-dialog" style="width: 100%;margin: 0;height: 100%;max-width: none;">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Version Comparison</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body p-0">
                <div class="filter-container">
                 <div style="display: flex;align-items: center;justify-content: center;gap: 10px 10px;flex-wrap:wrap;">
                        <label><b>Current Version:</b> ${$('#planName').val()}</label><br/>
                        <label><b>Comparison Version<span style="color:#FF0000" >*</span>:</b></label><br/>
                            <div class="dropdown">
                            <select id="versionDropdown" style="padding: 6px 8px;border: 1px solid;border-radius: 5px;font-size: 0.875rem; width: 150px;">
                            </select>
                            </div>

                        <label><b>LOB:</b></label><br/>
                            <div class="dropdown">
                                <button class="btn btn-sm dropdown-toggle" type="button" id="lobDropdownBtn" data-bs-toggle="dropdown" style="border: 1px solid;border-radius: 5px;">Select LOBs</button>
                                <div class="dropdown-menu dropdown-checkbox" aria-labelledby="lobDropdownBtn" id="lobDropdown"></div>
                            </div>

 <label><b>Week From:</b></label><br/>
                            <div class="dropdown">
                                <button class="btn btn-sm dropdown-toggle" type="button" id="weekFromDropdownBtn" data-bs-toggle="dropdown" style="border: 1px solid;border-radius: 5px;">Select From Week</button>
                                <div class="dropdown-menu dropdown-checkbox" aria-labelledby="weekFromDropdownBtn" id="weekFromDropdown"></div>
                            </div>

<label><b>Week To:</b></label><br/>
                            <div class="dropdown">
                                <button class="btn btn-sm dropdown-toggle" type="button" id="weekToDropdownBtn" data-bs-toggle="dropdown" style="border: 1px solid;border-radius: 5px;">Select To Week</button>
                                <div class="dropdown-menu dropdown-checkbox" aria-labelledby="weekToDropdownBtn" id="weekToDropdown"></div>
                            </div>
                            <button id="applyFilterBtn" class="btn btn-primary btn-sm">Apply Filter</button>
                  </div>
                  </div>
                </div>  
                <div class="vc-table-outer" style="margin:10px;">
                    <div class="table-wrapper" id="versionComparisonContainer"></div>
                </div>
              </div>
            </div>
          </div>
        </div>`;

        const $toolbar = $(modalHTML);
        $('body').append($toolbar);

        const $container = $('#versionComparisonContainer');

        // Initial dataset derived values
        let weeks = [...new Set(settings.data.map(d => d.week))].sort((a, b) => new Date(a) - new Date(b));
        let lobs = [...new Set(settings.data.map(d => d.lob))];

        populateFilters();

        // Table wrapper used for bottom scrolling
        const $tableWrapper = $('<div class="sim-table-wrapper"></div>');

        // Filters events (kept largely same as your original)
        $('#lobDropdown').on('change', '.lobSelectAll', function () {
            const checked = $(this).is(':checked');
            $('.lobCheckbox').prop('checked', checked);
            updateDropdownLabel('lobDropdown', checked ? lobs.slice() : [], 'Select LOBs');
        });

        $('#lobDropdown').on('change', '.lobItem', function () {
            const allChecked = $('.lobItem').length === $('.lobItem:checked').length;
            $('.lobSelectAll').prop('checked', allChecked);

            const selectedLobs = $('.lobItem:checked').map(function () {
                return $(this).val();
            }).get();

            updateDropdownLabel('lobDropdown', selectedLobs, 'Select LOBs');
        });

        $('#weekFromDropdown').on('change', 'input[type=radio]', function () {
            const selectedWeek = $('#weekFromDropdown input[type=radio]:checked').val();
            updateRadioDropdownLabel('weekFromDropdownBtn', selectedWeek, 'From');
        });
        $('#weekToDropdown').on('change', 'input[type=radio]', function () {
            const selectedWeek = $('#weekToDropdown input[type=radio]:checked').val();
            updateRadioDropdownLabel('weekToDropdownBtn', selectedWeek, 'To');
        });

        $('#applyFilterBtn').on('click', function () {
            if (!$('#versionDropdown').val()) {
                if (typeof toastr !== 'undefined') toastr.error("Comparison Version not selected.");
                else alert("Comparison Version not selected.");
                return;
            }
            getPlannerDataById();
        });

        // Populate dropdowns & filters
        function populateFilters() {
            // LOB
            const lobContainer = document.createDocumentFragment();
            const selectAllLabel = document.createElement('label');
            selectAllLabel.innerHTML = `<label><input type="checkbox" class="lobSelectAll" checked> <b>Select All</b></label><br/>`;
            lobContainer.appendChild(selectAllLabel);
            lobs.forEach(lob => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" class="lobCheckbox lobItem" value="${lob}" checked> ${lob}`;
                lobContainer.appendChild(label);
                lobContainer.appendChild(document.createElement('br'));
            });
            $('#lobDropdown').append(lobContainer);

            // Weeks -> Week From/To radio lists
            const weekFrom = weeks[0];
            weeks.forEach(week => {
                $('#weekFromDropdown').append(`<label style="display:block;padding:2px;"><input type="radio" name="weekFrom" value="${week}" ${week === weekFrom ? 'checked' : ''}> ${week}</label>`);
                $('#weekToDropdown').append(`<label style="display:block;padding:2px;"><input type="radio" name="weekTo" value="${week}" ${week === weeks[weeks.length - 1] ? 'checked' : ''}> ${week}</label>`);
            });

            updateDropdownLabel('lobDropdown', lobs, 'Select LOBs');
            updateRadioDropdownLabel('weekFromDropdownBtn', weekFrom, 'From');
            updateRadioDropdownLabel('weekToDropdownBtn', weeks[weeks.length - 1], 'To');
        }

        function updateDropdownLabel(dropdownId, selectedItems, placeholder) {
            const btn = $(`#${dropdownId}Btn`);
            if (!btn.length) return;
            btn.text(selectedItems.length === 0 ? placeholder : `${placeholder.split(' ')[0]} (${selectedItems.length}) selected`);
        }
        function updateRadioDropdownLabel(dropdownBtnId, selectedValue, prefix) {
            const btn = $(`#${dropdownBtnId}`);
            if (!btn.length) return;
            btn.text(`${prefix}: ${selectedValue}`);
        }

        // Fetch comparison plans (keeps your AJAX)
        function getComparisonPlans() {
            $('#versionDropdown').empty();
            var data = {
                'vertical': $("#verticalName").val(),
                'account': $('#labAccountName').text(),
                'groupName': $("#groupName").val(),
                'rpPlanId': $("#planId").val(),
            };

            $.ajax({
                url: '/resourceplanner/GetComparisonPlans',
                type: "POST",
                async: true,
                cache: false,
                data: JSON.stringify(data),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    if (response?.data?.length) {
                        $('#versionDropdown').append('<option value="">Select Version</option>');
                        $.each(response.data, function (index, item) {
                            $('#versionDropdown').append(
                                $('<option>', {
                                    value: item.rpPlanId,
                                    text: item.name
                                })
                            );
                        });
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    if (typeof toastr !== 'undefined') toastr.error("Error fetching Plans. Please try again.");
                    else console.error("Error fetching Plans.", errorThrown);
                }
            });
        }

        // Fetch planner data for selected comparison version
        function getPlannerDataById() {
            const weekFrom = $('#weekFromDropdown input[type=radio]:checked').val();
            const weekTo = $('#weekToDropdown input[type=radio]:checked').val();
            var data = {
                'rpPlanId': $('#versionDropdown').val(),
                'vertical': $("#verticalName").val(),
                'stWeek': weekFrom,
                'edWeek': weekTo
            };
            $.ajax({
                url: '/resourceplanner/GetPlannerDataById',
                type: "POST",
                async: true,
                cache: false,
                data: JSON.stringify(data),
                contentType: "application/json",
                dataType: "json",
                success: function (response) {
                    if (response?.length) {
                        try {
                            let filterData = settings.processData ? settings.processData(response) : response;
                            let transformed = settings.transformData ? settings.transformData(filterData) : filterData;
                            const selectedLOBs = $('.lobCheckbox:checked').map(function () { return this.value; }).get();
                            buildComparisonTable(transformed, settings.data, selectedLOBs, weekFrom, weekTo);
                        } catch (err) {
                            console.error("process/transform function error:", err);
                        }
                    }
                },
                error: function (xhr, textStatus, errorThrown) {
                    if (typeof toastr !== 'undefined') toastr.error("Error fetching Plans. Please try again.");
                    else console.error("Error fetching Plans.", errorThrown);
                }
            });

        }

        // Build table data (filters and calls renderer)
        function buildComparisonTable(prvData, curData, selectedLOBs, weekFrom, weekTo) {
            curData = fiterData(curData, selectedLOBs, weekFrom, weekTo);
            prvData = fiterData(prvData, selectedLOBs, weekFrom, weekTo);
            weeks = [...new Set(curData.map(d => d.week))].sort((a, b) => new Date(a) - new Date(b));
            lobs = [...new Set(curData.map(d => d.lob))];
            renderTable(curData, prvData, weeks, lobs);
        }

        function fiterData(data, selectedLOBs, weekFrom, weekTo) {
            return data.filter(item => {
                const weekDate = parseComparisonWeekDate(item.week); // convert to Date object
                const fromDate = parseComparisonWeekDate(weekFrom);
                const toDate = parseComparisonWeekDate(weekTo);
                const isLOBMatch = selectedLOBs.length === 0 || selectedLOBs.includes(item.lob);
                const isWeekInRange = weekDate >= fromDate && weekDate <= toDate;
                return isLOBMatch && isWeekInRange;
            });
        }

        // RENDER table (keeps your metrics, arrows, formatting)
        function renderTable(curData, prvData, weeks, lobs) {
            $tableWrapper.empty();
            const $table = $('<table class="table sim-table min-w-max border-collapse border border-gray-200"></table>');
            $tableWrapper.append($table);
            $container.append($tableWrapper);

            // Table header
            let headerHtml = `<thead><tr>
                <th class="sticky-1 border" nowrap>LOB / Overall</th>
                <th class="sticky-2 border" nowrap>Metric</th>`;
            weeks.forEach(w => headerHtml += `<th class="border text-center week-cell" colspan="2" nowrap>${w}</th>`);
            headerHtml += `</tr><tr><th></th><th></th>`;
            weeks.forEach(_ => headerHtml += `<th class="cell-manual-sim"  nowrap>Selected</th><th style="min-width:55px;" nowrap>Current</th>`);
            headerHtml += `</tr></thead>`;
            $table.append(headerHtml);
            const $tbody = $('<tbody></tbody>');
            $table.append($tbody);

            const metrics = ['FTE Required', 'FTE Available', 'Delta', 'Staffing %', 'Planned Shrinkage %',  'Planned Attrition %'];
            const percentMetrics = ['Staffing %', 'Planned Shrinkage %', 'Planned Attrition %'];

            // Overall rows
            metrics.forEach(metric => {
                const $tr = $('<tr></tr>');
                if (metric === 'FTE Required') $tr.append(`<td class="sticky-1 font-bold" rowspan="${metrics.length}" nowrap>Overall</td>`);
                $tr.append(`<td class="sticky-2" nowrap>${metric}</td>`);
                weeks.forEach(week => {
                    const curweekData = lobs.map(lob => getData(curData, lob, week)).filter(d => d);
                    let current = 'NA', previous = 'NA';
                    if (curweekData.length) {
                        const curVals = curweekData.map(d => {
                            switch (metric) {
                                case 'FTE Required': return d.fteRequired;
                                case 'FTE Available': return d.fteAvailable;
                                case 'Delta': return d.delta;
                                case 'Staffing %': return d.staffingPct;
                                case 'Planned Shrinkage %': return d.plannedShrinkage;
                                case 'Planned Attrition %': return d.plannedAttrition ?? 0;
                                default: return null;
                            }
                        }).filter(v => v != null && !isNaN(v));
                        if (curVals.length) current = percentMetrics.includes(metric) ? fmt(curVals.reduce((a, b) => a + b, 0) / curVals.length, metric) : fmt(curVals.reduce((a, b) => a + b, 0), metric);
                    }

                    const prvweekData = lobs.map(lob => getData(prvData, lob, week)).filter(d => d);
                    if (prvweekData.length) {
                        const prvVals = prvweekData.map(d => {
                            switch (metric) {
                                case 'FTE Required': return d.fteRequired;
                                case 'FTE Available': return d.fteAvailable;
                                case 'Delta': return d.delta;
                                case 'Staffing %': return d.staffingPct;
                                case 'Planned Shrinkage %': return d.plannedShrinkage;
                                case 'Planned Attrition %': return d.plannedAttrition ?? 0;
                                default: return null;
                            }
                        }).filter(v => v != null && !isNaN(v));
                        if (prvVals.length) previous = percentMetrics.includes(metric) ? fmt(prvVals.reduce((a, b) => a + b, 0) / prvVals.length, metric) : fmt(prvVals.reduce((a, b) => a + b, 0), metric);
                    }
                    const isNeg = !isNaN(current) && parseFloat(current) < 0;
                    const arrow = getArrow(previous, current);
                    const valDisplay = current + (percentMetrics.includes(metric) && current !== 'NA' ? '%' : '');
                    $tr.append(`
                                <td class="text-right cell-manual-sim" nowrap>${previous}${percentMetrics.includes(metric) && current !== 'NA' ? '%' : ''}</td>
                                <td class="text-right ${isNeg ? 'text-red' : ''}" nowrap>${valDisplay}<span style="float:right;color:${arrow === 'ðŸ¡…' ? 'green' : arrow === 'ðŸ¡‡' ? 'red' : ''}">${arrow}</span></td>
                                   `);
                });
                $tbody.append($tr);
            });

            // LOB rows
            lobs.forEach(lob => {
                metrics.forEach(metric => {
                    const $tr = $('<tr></tr>');
                    if (metric === 'FTE Required') $tr.append(`<td class="sticky-1 font-semibold" rowspan="${metrics.length}" nowrap>${lob}</td>`);
                    $tr.append(`<td class="sticky-2" nowrap>${metric}</td>`);
                    weeks.forEach(week => {
                        const cd = getData(curData, lob, week);
                        let current = 'NA', previous = 'NA';
                        if (cd) {
                            switch (metric) {
                                case 'FTE Required': current = fmt(cd.fteRequired); break;
                                case 'FTE Available': current = fmt(cd.fteAvailable); break;
                                case 'Delta': current = fmt(cd.delta); break;
                                case 'Staffing %': current = fmt(cd.staffingPct); break;
                                case 'Planned Shrinkage %': current = fmt(cd.plannedShrinkage, metric); break;
                                case 'Planned Attrition %': current = fmt(cd.plannedAttrition ?? 0, metric); break;
                            }
                        }

                        const pd = getData(prvData, lob, week);
                        if (pd) {
                            switch (metric) {
                                case 'FTE Required': previous = fmt(pd.fteRequired); break;
                                case 'FTE Available': previous = fmt(pd.fteAvailable); break;
                                case 'Delta': previous = fmt(pd.delta); break;
                                case 'Staffing %': previous = fmt(pd.staffingPct); break;
                                case 'Planned Shrinkage %': previous = fmt(pd.plannedShrinkage, metric); break;
                                case 'Planned Attrition %': previous = fmt(pd.plannedAttrition ?? 0, metric); break;
                            }
                        }
                        const isNeg = !isNaN(current) && parseFloat(current) < 0;
                        const arrow = getArrow(previous, current);
                        const valDisplay = current + (percentMetrics.includes(metric) && current !== 'NA' ? '%' : '');
                        $tr.append(` 
                                      <td class="text-right  cell-manual-sim" nowrap>${previous}${percentMetrics.includes(metric) && previous !== 'NA' ? '%' : ''}</td>
                                      <td class="text-right ${isNeg ? 'text-red' : ''}" nowrap>${valDisplay}<span style="float:right;color:${arrow === 'ðŸ¡…' ? 'green' : arrow === 'ðŸ¡‡' ? 'red' : ''}">${arrow}</span></td>
                                         `);
                    });
                    $tbody.append($tr);
                });
            });

            // After render: adjust sticky column widths & setup scroll handlers
            setupStickyColumns($table, $tableWrapper);
        }

        // Function to set left offsets and widths for sticky columns and ensure header sticks
        function setupStickyColumns($table, $wrapper) {
            // compute widths of first & second columns from header cells
            const $firstTh = $table.find('thead tr').first().find('th').first();
            const $secondTh = $table.find('thead tr').first().find('th').eq(1);

            // fallback widths if not measured
            const firstWidth = $firstTh.length ? $firstTh.outerWidth() : 140;
            const secondWidth = $secondTh.length ? $secondTh.outerWidth() : 150;

            // Apply left offsets and min-widths for sticky-1 and sticky-2 in both header and body cells
            $table.find('.sticky-1').each(function () {
                $(this).css({ left: 0, 'min-width': firstWidth + 'px' });
            });
            $table.find('.sticky-2').each(function () {
                $(this).css({ left: firstWidth + 'px', 'min-width': secondWidth + 'px' });
            });

            // Also ensure header th's which are sticky get same left values
            $table.find('thead th').each(function (idx) {
                if (idx === 0) $(this).css({ left: 0 });
                if (idx === 1) $(this).css({ left: firstWidth + 'px' });
            });

            // Ensure header has higher z-index than sticky columns (already set in CSS)
            // No top scrollbar or sync needed - only bottom scrollbar (the wrapper) handles horiz scroll

            // Bind scroll handler to wrapper to keep header/columns stable (no work needed, CSS sticky handles it)
            // But we need to ensure when wrapper scrolls horizontally, nothing else required.

            // Recompute on resize (debounced)
            clearTimeout(window.__vcResizeTimer);
            window.__vcResizeTimer = setTimeout(function () {
                // Recalculate widths if content or font-size changed
                const newFirstW = $firstTh.length ? $firstTh.outerWidth() : firstWidth;
                const newSecondW = $secondTh.length ? $secondTh.outerWidth() : secondWidth;

                $table.find('.sticky-1').css({ 'min-width': newFirstW + 'px' });
                $table.find('.sticky-2').css({ 'min-width': newSecondW + 'px', left: newFirstW + 'px' });

                $table.find('thead th').each(function (idx) {
                    if (idx === 0) $(this).css({ left: 0 });
                    if (idx === 1) $(this).css({ left: newFirstW + 'px' });
                });

            }, 100);
        }

        // Helpers copied/kept
        function getData(data, lob, week) {
            return data.find(d => d.lob === lob && d.week === week);
        }

        const fmt = (val, metric) => (val !== null && val !== undefined && !isNaN(val)) ?
            (metric?.includes("Shrinkage") || metric?.includes("Attrition")) ? parseFloat(val).toFixed(1) : parseFloat(val).toFixed(0)
            : 'NA';

        function getArrow(prv, cur) {
            if (prv === 'NA' || cur === 'NA') return '';
            prv = parseFloat(prv);
            cur = parseFloat(cur);
            if (prv < cur) return 'ðŸ¡…';
            if (prv > cur) return 'ðŸ¡‡';
            return '';
        }
        function parseComparisonWeekDate(weekStr) {
            const [day, month, year] = weekStr.split('-');
            return new Date(`${day} ${month} 20${year}`);
        }

        // initial load of comparison plans
        getComparisonPlans();

        // Show Modal (after building)
        const versionComparisonModal = new bootstrap.Modal(document.getElementById('versionComparisonModal'));
        versionComparisonModal.show();

    };
}(jQuery));
