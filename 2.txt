(function ($) {
    $.fn.sheetConfigurator = function (options) {
        const settings = $.extend({
            luckysheetInstances: [],
            existingConfigs: {},     // saved configs
            activeSheet: null,
            saveCallback: function (config, sheetName) { },
            getSheetDataFn: function (sheetName) { return []; }
        }, options);

        let tempConfigs = {};  // live while dialog open only

        // Inject modal once
        if (!$('#sheetConfigModal').length) {
            $('body').append(`
              <div class="modal fade" id="sheetConfigModal" tabindex="-1" style="z-index:9999;zoom:75%">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                      <h5 class="modal-title">Sheet Configuration</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <form id="sheetConfigForm" class="container-fluid">
                        <div class="row mb-3">
                          <div class="col-md-6">
                            <label class="form-label">Sheet</label>
                            <select class="form-select" id="configSheetSelect"></select>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Sheet Type</label>
                            <select class="form-select" id="configSheetType">
                              <option value="">--Select--</option>
                              <option value="custom">Custom</option>
                              <option value="lob">LOB</option>
                            </select>
                          </div>
                        </div>

                        <div id="lobInputs" style="display:none;">
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label class="form-label">LOB Type</label>
                              <select class="form-select" id="configLobType">
                                <option value="FTE">FTE</option>
                                <option value="Transaction">Transaction</option>
                              </select>
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">Location</label>
                              <select class="form-select" id="configLocation">
                                <option value="Bulgaria">Bulgaria</option>
                                <option value="Canada">Canada</option>
                                <option value="China">China</option>
                                <option value="Colombia">Colombia</option>
                                <option value="Egypt">Egypt</option>
                                <option value="India">India</option>
                                <option value="Jamaica">Jamaica</option>
                                <option value="Kosovo">Kosovo</option>
                                <option value="Malaysia">Malaysia</option>
                                <option value="Mexico">Mexico</option>
                                <option value="Philippines">Philippines</option>
                                <option value="USA">USA</option>
                              </select>
                            </div>
                          </div>
                         <div class="row mb-3"> 
                            <div class="col-md-6">   
                                <label class="form-label">Site</label>    
                                <input type="text" class="form-control" id="configSite" />  
                            </div>
                            <div class="col-md-6">   
                                <label class="form-label">ProjectId</label>    
                                <input type="text" class="form-control" id="configProjectId" />  
                            </div> 
                            </div>
                          <div class="row mb-3">
                            <div class="col-md-6">
                              <label class="form-label">Week Header Row</label>
                              <input type="number" min="1" class="form-control" id="configWeekRow" />
                              <div class="form-text">Row number that contains dates.</div>
                              <small class="text-muted" id="weekDateLabel"></small>
                            </div>
                            <div class="col-md-6">
                              <label class="form-label">Header Column</label>
                              <input type="text" class="form-control" id="configHeaderCol" />
                              <div class="form-text">Column with headers.</div>
                            </div>
                          </div>
                        </div>

                        <div id="headerMappingContainer" class="mt-3"></div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      <button type="button" class="btn btn-primary" id="saveConfigBtn">Save</button>
                    </div>
                  </div>
                </div>
              </div>
            `);
        }

        const $sheetSelect = $('#configSheetSelect');
        const $sheetType = $('#configSheetType');
        const $lobInputs = $('#lobInputs');
        const $site = $('#configSite');
        const $projectId = $('#configProjectId');
        const $weekRow = $('#configWeekRow');
        const $headerCol = $('#configHeaderCol');
        const $mappingContainer = $('#headerMappingContainer');
        const $weekLabel = $('#weekDateLabel');

        // Reset on modal close (discard temp)
        $('#sheetConfigModal').off('hidden.bs.modal').on('hidden.bs.modal', function () {
            tempConfigs = {};
        });

        // === Helpers ===
        function getFormConfig(sheetName) {
            const cfg = {
                sheetName,
                type: $sheetType.val(),
                lobType: $('#configLobType').val(),
                location: $('#configLocation').val(),
                site: $site.val(),
                projectId: $projectId.val(),
                weekRow: $weekRow.val(),
                headerCol: $headerCol.val(),
                headerMappings: {}
            };
            $('.mapping-dropdown').each(function () {
                const std = $(this).data('std');
                const val = $(this).val();
                if (val) cfg.headerMappings[std] = val;
            });
            return cfg;
        }

        function bindConfig(config) {
            // reset first
            $sheetType.val('').trigger('change');
            $lobInputs.hide();
            $site.val('');
            $projectId.val('');
            $weekRow.val('');
            $headerCol.val('');
            $mappingContainer.empty();
            $weekLabel.text('');

            if (!config) return;

            $sheetType.val(config.type || '').trigger('change');
            if (config.type === 'lob') $lobInputs.show();

            $('#configLobType').val(config.lobType || 'fte');
            $('#configLocation').val(config.location || 'us');
            $site.val(config.site || '');
            $projectId.val(config.projectId || '');
            $weekRow.val(config.weekRow || '');
            $headerCol.val(config.headerCol || '');

            if (config.headerCol) {
                const sheetData = settings.getSheetDataFn(config.sheetName);
                buildHeaderMapping(sheetData, config.headerCol, config.headerMappings || {});
            }
        }

        function validateWeekRow(sheet, rowNum) {
            const row = sheet.data ? sheet.data[rowNum - 1] : sheet[rowNum - 1];
            if (!row) return { valid: false };
            let start = null, end = null;
            row.forEach(cell => {
                const val = cell && (cell.m || cell.v);
                if (val && !isNaN(Date.parse(val))) {
                    if (start === null) start = val;
                    end = val;
                }
            });
            return { valid: start !== null, start, end };
        }

        function buildHeaderMapping(sheetData, colInput, existingMappings) {
            if (!colInput) return;
            let colIdx = isNaN(colInput)
                ? colInput.toUpperCase().charCodeAt(0) - 65
                : parseInt(colInput) - 1;

            const headers = [];
            for (let r = 0; r < sheetData.length; r++) {
                const cell = sheetData[r][colIdx];
                if (cell) {
                    const val = cell.m || cell.v || "";
                    if (val) headers.push(val);
                }
            }
            headers.push("Not Applicable");
            const uniqueHeaders = [...new Set(headers.filter(h => h.trim() !== ""))];

            $mappingContainer.empty();
            if (!uniqueHeaders.length) return;

            const standardHeaders = ["Client Lock", "Forecasted Hours", "Actual Hours", "Required HC", "Available HC", "Planned Attrition", "Actual Attrition", "Planned Shrinkage", "Actual Shrinkage", "Planned AHT", "Actual AHT"];
            standardHeaders.forEach(std => {
                let options = uniqueHeaders.map(h =>
                    `<option value="${h}" ${existingMappings && existingMappings[std] === h ? "selected" : ""}>${h}</option>`
                ).join("");
                $mappingContainer.append(`
                  <div class="row mb-2">
                    <div class="col-md-6"><label class="form-label">${std}</label></div>
                    <div class="col-md-6">
                      <select class="form-select mapping-dropdown" data-std="${std}">
                        <option value="">--Select--</option>
                        ${options}
                      </select>
                    </div>
                  </div>
                `);
            });
        }

        // === Populate sheet dropdown ===
        $sheetSelect.empty();
        settings.luckysheetInstances.forEach(name => {
            $sheetSelect.append(`<option value="${name}">${name}</option>`);
        });

        if (settings.activeSheet) {
            $sheetSelect.val(settings.activeSheet);
            bindConfig(settings.existingConfigs[settings.activeSheet] || null);
            $sheetSelect.data('lastSheet', settings.activeSheet);
        }

        // Switch sheets inside dialog
        $sheetSelect.off('change').on('change', function () {
            const prevSheet = $(this).data('lastSheet');
            const newSheet = $(this).val();
            if (prevSheet) {
                tempConfigs[prevSheet] = getFormConfig(prevSheet);
            }
            const config = tempConfigs[newSheet] || settings.existingConfigs[newSheet] || null;
            bindConfig(config);
            $(this).data('lastSheet', newSheet);
        });

        // Week row validation
        $weekRow.off('blur').on('blur', function () {
            const sheetName = $sheetSelect.val();
            const sheetData = settings.getSheetDataFn(sheetName) || [];
            const weekCheck = validateWeekRow({ data: sheetData }, parseInt($(this).val()));
            if (weekCheck.valid) {
                $weekLabel.text(`Start: ${weekCheck.start} → End: ${weekCheck.end}`);
            } else {
                $weekLabel.text("Invalid week row (no dates found).");
            }
        });

        // Header col input
        $headerCol.off('blur').on('blur', function () {
            const sheetName = $sheetSelect.val();
            const sheetData = settings.getSheetDataFn(sheetName) || [];
            buildHeaderMapping(sheetData, $(this).val(), {});
        });

        // Save button
        $('#saveConfigBtn').off('click').on('click', function () {
            const sheetName = $sheetSelect.val();
            const config = getFormConfig(sheetName);

            //if (config.type === "lob") {
            //    const sheetData = settings.getSheetDataFn(sheetName) || [];
            //    const weekCheck = validateWeekRow({ data: sheetData }, parseInt(config.weekRow));
            //    if (!weekCheck.valid) {
            //        alert("Week header row must contain at least one valid date.");
            //        return;
            //    }
            //    config.weekRange = { start: weekCheck.start, end: weekCheck.end };

            //    for (const std of ["FTE Required", "FTE Available", "Transactions", "Productivity"]) {
            //        if (!config.headerMappings[std]) {
            //            alert(`Please map header for ${std}`);
            //            return;
            //        }
            //    }
            //}

            settings.existingConfigs[sheetName] = config; // persist
            delete tempConfigs[sheetName];
            settings.saveCallback(config, sheetName);
           /* $('#sheetConfigModal').modal('hide');*/
        });

        // Toggle LOB inputs
        $sheetType.off('change').on('change', function () {
            if ($(this).val() === 'lob') $lobInputs.show();
            else {
                $lobInputs.hide();
                $mappingContainer.empty();
            }
        });

        return this;
    };
})(jQuery);
