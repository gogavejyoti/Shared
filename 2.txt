(function enforceCorrectOrder() {
    const maxPass = ordered.length * 2;
    let pass = 0;
    let changed = true;

    while (changed && pass++ < maxPass) {
        changed = false;

        for (let i = 0; i < ordered.length; i++) {
            const node = ordered[i];
            if (!node || !node.parents) continue;

            for (const pk in node.parents) {
                // parent not in execution list → ignore
                const pIndex = ordered.findIndex(x => x.key === pk);
                if (pIndex === -1) continue;

                // ❌ parent is AFTER child → swap
                if (pIndex > i) {
                    const parentNode = ordered[pIndex];

                    // remove parent
                    ordered.splice(pIndex, 1);
                    // insert parent just before child
                    ordered.splice(i, 0, parentNode);

                    changed = true;
                    break;
                }
            }
            if (changed) break;
        }
    }
})();
