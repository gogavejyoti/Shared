function recalcPercentSafe() {
    const sheets = luckysheet.getLuckysheetfile();

    sheets.forEach((sheet, sheetIdx) => {
        const chain = sheet.calcChain;
        if (!chain) return;

        let batchCount = 0;

        function processBatch(start) {
            for (let i = start; i < chain.length; i++) {
                const item = chain[i];
                const r = item.r;
                const c = item.c;

                const cell = sheet.data[r]?.[c];
                if (cell && cell.f && cell.f.includes("%")) {
                    // Only safe internal calculation function
                    luckysheet.calculateFormula(r, c, sheetIdx);
                }

                batchCount++;

                // After every 200 formulas, pause to let memory clear
                if (batchCount % 200 === 0) {
                    setTimeout(() => processBatch(i + 1), 0);
                    return;
                }
            }
        }

        // Start batch processing
        processBatch(0);
    });
}
