(function ($) {
    $.fn.generateDynamicChart = function (options) {
        let settings = $.extend({
            botTextContainer: null, // Where result text will be shown
            data: []
        }, options);

        if (!settings.data || settings.data.length === 0) {
            console.error("No data provided for the chart.");
            return this;
        }

        // Identify numeric and non-numeric fields
        let sampleItem = settings.data[0];
        let nonNumericFields = [];
        let numericFields = [];
        let percentageFields = [];

        Object.keys(sampleItem).forEach(key => {
            if (isNaN(sampleItem[key]) || sampleItem[key] === '') {
                nonNumericFields.push(key);
            } else {
                numericFields.push(key);
                if (key.toLowerCase().includes("percentage") || key.includes("%")) {
                    percentageFields.push(key);
                }
            }
        });

        // Determine category field (last non-numeric field)
        let categoryField = nonNumericFields.length > 0 ? nonNumericFields[nonNumericFields.length - 1] : Object.keys(sampleItem)[0];

        // Prepare data for ApexCharts
        let categories = settings.data.map(item => item[categoryField]);
        let seriesData = numericFields.map(key => ({
            name: key,
            data: settings.data.map(item => parseFloat(item[key]))
        }));

        // Determine best chart type
        let chartType = numericFields.length > 1 ? "bar" : "line";
        if (numericFields.length === 1 && settings.data.length <= 5) {
            chartType = "pie";
        }

        // Create main container
        let chatBox = $("#chatBox");

        let mainContainer = $("<div>").addClass("chat-result card p-3 mb-3 shadow-sm").css({
            width: "100%",
            maxWidth: "700px",
            border: "1px solid #ddd",
            borderRadius: "10px",
            padding: "15px"
        });

        // Table container
        let tableContainer = $("<div>").addClass("table-responsive").css({
            width: "100%",
            maxHeight: "250px",
            overflowY: "auto",
            marginBottom: "15px",
            padding: "10px",
            border: "1px solid #ccc",
            borderRadius: "5px",
            backgroundColor: "#f8f9fa"
        });

        let table = $("<table>").addClass("table table-bordered table-striped text-center").css({
            width: "100%",
            fontSize: "14px"
        });

        let thead = $("<thead>").append("<tr></tr>");
        let tbody = $("<tbody></tbody>");

        // Table Header
        Object.keys(sampleItem).forEach(key => {
            thead.find("tr").append($("<
