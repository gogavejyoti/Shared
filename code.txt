// ---------- Topological sort (Excel-style: Kahn / in-degree) ----------
const ordered = [];
const inDegree = {};
const queue = [];

// Initialize in-degree ONLY within impacted subgraph
for (const k of impacted) {
    const node = nodes[k];
    if (!node) continue;

    let deg = 0;
    for (const pk in node.parents) {
        if (impacted.has(pk)) deg++;
    }
    inDegree[k] = deg;

    if (deg === 0) queue.push(node);
}

// Process
while (queue.length > 0) {
    const cur = queue.shift();
    ordered.push(cur);

    for (const ck in cur.children) {
        if (!impacted.has(ck)) continue;
        inDegree[ck]--;
        if (inDegree[ck] === 0) {
            queue.push(nodes[ck]);
        }
    }
}

// Safety: cycle detection (Excel marks circular refs)
if (ordered.length !== [...impacted].filter(k => nodes[k]).length) {
    console.warn("Circular dependency detected in formula graph");
}
