(function ($) {
    $.fn.generateDynamicChart = function (options) {
        let settings = $.extend({
            botTextContainer: null,
            userInput: '',
            data: []
        }, options);

        if (!settings.data || settings.data.length === 0) {
            console.error("No data provided for the chart.");
            return this;
        }

        let sampleItem = settings.data[0];
        let headers = Object.keys(sampleItem);

        // Identify if there is a date-like column
        let timeColumn = headers.find(col => settings.data.every(row => isDateLike(row[col])));
        let categoryColumn = headers.find(col => col !== timeColumn && isCategoryColumn(col, settings.data));

        if (!timeColumn && !categoryColumn) {
            console.error("No valid time-based or category column found.");
            return this;
        }

        // Determine Transposition Type
        let transposeByTime = timeColumn && settings.data.length > 1; // If multiple time periods exist
        let transposeByCategory = categoryColumn && !transposeByTime; // If only one period but multiple accounts exist

        let nameColumns = headers.filter(col => col !== timeColumn && col !== categoryColumn);

        let transposedData = [];

        if (transposeByTime) {
            // Transpose by Time Period
            transposedData = nameColumns.map(name => {
                let row = { "Name": name };
                settings.data.forEach(entry => {
                    row[entry[timeColumn]] = formatValue(entry[name], name);
                });
                return row;
            });
        } else if (transposeByCategory) {
            // Transpose by Account or Other Categories
            transposedData = nameColumns.map(name => {
                let row = { "Metric": name };
                settings.data.forEach(entry => {
                    row[entry[categoryColumn]] = formatValue(entry[name], name);
                });
                return row;
            });
        }

        // Generate Table
        let chatBox = $("#chatBox");
        let mainContainer = $("<div>").addClass("chat-result card p-3 mb-3 shadow-sm").css({
            width: "100%",
            border: "1px solid #ddd",
            borderRadius: "10px",
            padding: "15px"
        });

        let tableContainer = $("<div>").addClass("table-responsive").css({
            width: "100%",
            maxHeight: "250px",
            overflowY: "auto",
            marginBottom: "15px",
            padding: "10px",
            border: "1px solid #ccc",
            borderRadius: "5px",
            backgroundColor: "#f8f9fa"
        });

        let table = $("<table>").addClass("table table-bordered table-striped text-center").css({
            width: "100%",
            fontSize: "14px"
        });

        let thead = $("<thead>").append("<tr></tr>");
        let tbody = $("<tbody></tbody>");

        let transposedHeaders = transposeByTime
            ? ["Name", ...settings.data.map(item => item[timeColumn])]
            : ["Metric", ...settings.data.map(item => item[categoryColumn])];

        transposedHeaders.forEach(key => {
            thead.find("tr").append($("<th>").text(key).addClass("bg-primary text-white"));
        });

        transposedData.forEach(row => {
            let tr = $("<tr></tr>");
            transposedHeaders.forEach(key => {
                tr.append($("<td>").text(row[key] || ""));
            });
            tbody.append(tr);
        });

        table.append(thead).append(tbody);
        tableContainer.append(table);
        mainContainer.append(tableContainer);

        // Generate Chart
        let categories = transposedHeaders.slice(1);
        let seriesData = transposedData.map(row => ({
            name: row[transposeByTime ? "Name" : "Metric"],
            data: categories.map(label => parseFloat(row[label]) || 0)
        }));

        let chartContainer = $("<div>").css({
            width: "100%",
            height: "350px",
            border: "1px solid #ccc",
            borderRadius: "5px",
            backgroundColor: "#fff",
            padding: "10px"
        });

        $('.bot-message:last').remove();
        mainContainer.append(chartContainer);
        chatBox.append(mainContainer);

        let chartOptions = {
            chart: { type: "bar", height: 320 },
            series: seriesData,
            xaxis: { categories: categories },
            tooltip: {
                y: {
                    formatter: function (value, { seriesIndex, dataPointIndex, w }) {
                        let name = w.config.series[seriesIndex].name;
                        return formatValue(value, name);
                    }
                }
            },
            dataLabels: {
                enabled: true,
                formatter: function (value, { seriesIndex, dataPointIndex, w }) {
                    let name = w.config.series[seriesIndex].name;
                    return formatValue(value, name);
                }
            }
        };

        let chart = new ApexCharts(chartContainer[0], chartOptions);
        chart.render();

        return this;
    };

    function isDateLike(value) {
        if (typeof value !== 'string') return false;
        return /^(0?[1-9]|[12]\d|3[01])?[- ]?(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[- ]?\d{2,4}$/.test(value);
    }

    function isCategoryColumn(colName, data) {
        return data.every(row => typeof row[colName] === "string" && !isDateLike(row[colName]));
    }

    function formatValue(value, name) {
        if (typeof value === "number") {
            return name.toLowerCase().includes("percentage") || name.includes("%")
                ? value.toFixed(1)
                : value.toFixed(0);
        }
        return value;
    }
}(jQuery));
