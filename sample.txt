function _shiftCrossSheetReference({ type, sheetIndex, rowIndex, rowCount = 1, colIndex, colCount = 1 }) {
    const allSheets = Ft() || [];
    let sheetChanged = false;

    // 1️⃣ First pass: adjust references for row/col insert/delete
    for (let s = 0; s < allSheets.length; s++) {
        const sheet = allSheets[s];
        const data = sheet.data;

        for (let r = 0; r < data.length; r++) {
            for (let c = 0; c < data[r].length; c++) {
                const cell = data[r][c];
                if (!cell || !cell.f) continue;

                let originalFormula = cell.f;
                let modifiedFormula = originalFormula;
                let errorDetected = false;

                modifiedFormula = modifiedFormula.replace(/'([^']+)'!([A-Z]+)(\d+)/g, function (match, sheetName, colLetter, rowNumber) {
                    const refSheet = allSheets.find(sh => sh.name === sheetName);
                    if (!refSheet) return match;

                    let refRow = parseInt(rowNumber, 10);
                    let refCol = _columnLetterToIndex(colLetter);
                    let colDeleted = false;
                    let rowDeleted = false;

                    // Row shifts
                    if (type === "insertRow" && refSheet.index === sheetIndex && refRow >= rowIndex + 1) {
                        refRow += rowCount;
                    } else if (type === "deleteRow" && refSheet.index === sheetIndex) {
                        if (refRow > rowIndex && refRow <= rowIndex + rowCount) {
                            rowDeleted = true;
                            errorDetected = true;
                        } else if (refRow > rowIndex + rowCount) {
                            refRow -= rowCount;
                        }
                    }

                    // Column shifts
                    if (type === "insertCol" && refSheet.index === sheetIndex && refCol >= colIndex) {
                        refCol += colCount;
                    } else if (type === "deleteCol" && refSheet.index === sheetIndex) {
                        if (refCol >= colIndex && refCol < colIndex + colCount) {
                            colDeleted = true;
                            errorDetected = true;
                        } else if (refCol >= colIndex + colCount) {
                            refCol -= colCount;
                        }
                    }

                    const colPart = colDeleted ? "#REF!" : _columnIndexToLetter(refCol);
                    const rowPart = rowDeleted ? "#REF!" : refRow;
                    return `'${sheetName}'!${colPart}${rowPart}`;
                });

                if (modifiedFormula !== originalFormula) {
                    cell.f = modifiedFormula;
                    sheetChanged = true;

                    // Only mark #REF! for deletions
                    if (errorDetected && (type === "deleteRow" || type === "deleteCol")) {
                        cell.v = "#REF!";
                        cell.ct = { fa: "General", t: "e" };
                    }
                }
            }
        }
    }

    // 2️⃣ Recursive propagation of #REF! across dependent formulas
    let refChanged = true;
    while (refChanged) {
        refChanged = false;

        for (let s = 0; s < allSheets.length; s++) {
            const sheet = allSheets[s];
            const data = sheet.data;

            for (let r = 0; r < data.length; r++) {
                for (let c = 0; c < data[r].length; c++) {
                    const cell = data[r][c];
                    if (!cell || !cell.f) continue;
                    if (cell.v === "#REF!") continue;

                    let formula = cell.f;
                    let shouldRef = false;

                    formula.replace(/'([^']+)'!([A-Z]+)(\d+)/g, function (match, sheetName, colLetter, rowNumber) {
                        const refSheet = allSheets.find(sh => sh.name === sheetName);
                        if (!refSheet) return;

                        const refRow = parseInt(rowNumber, 10) - 1;
                        const refCol = _columnLetterToIndex(colLetter);

                        const refCell = refSheet.data[refRow]?.[refCol];
                        if (refCell && refCell.v === "#REF!") {
                            shouldRef = true;
                        }
                    });

                    if (shouldRef) {
                        cell.v = "#REF!";
                        cell.ct = { fa: "General", t: "e" };
                        refChanged = true;
                        sheetChanged = true;
                    }
                }
            }
        }
    }

    // 3️⃣ Trigger recalculation if any sheet changed
    if (sheetChanged) {
        if (typeof jf !== "undefined" && jf.refresh) {
            jf.refresh();
        } else if (typeof luckysheetrefreshgrid === "function") {
            luckysheetrefreshgrid();
        }
    }

    // Utility functions
    function _columnLetterToIndex(col) {
        let index = 0;
        for (let i = 0; i < col.length; i++) {
            index = index * 26 + (col.charCodeAt(i) - 65 + 1);
        }
        return index - 1;
    }

    function _columnIndexToLetter(index) {
        let col = "";
        index += 1;
        while (index > 0) {
            let rem = (index - 1) % 26;
            col = String.fromCharCode(65 + rem) + col;
            index = Math.floor((index - 1) / 26);
        }
        return col;
    }
}
